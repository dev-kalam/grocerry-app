<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Mudi Manager Mobile</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary: #428d92;
            --primary-dark: #15ccc3;
            --secondary: #677E8A;
            --accent: #122E34;
            --success: #16a34a;
            --success-light: #dcfce7;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --dark-bg: #122E34;
            --dark-card: #1a3d48;
            --dark-text: #e2e8f0;
            --dark-border: #2a4f5a;
            --light-bg: #f8fafc;
            --light-card: #ffffff;
            --light-text: #0f172a;
            --light-border: #e2e8f0;
            --bg-main: #f8fafc;
            --text-dark: #0f172a;
            --text-slate: #677E8A;
            --border: #e2e8f0;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --bg-color: #0f1720;
            --card-bg: #0b1220;
            --text-color: #e6eef5;
            --border-color: #9aa8b3;
            --primary: #4361ee;
            --primary-dark: #3350d1;
            --muted: #9aa8b3;
            --hover-bg: rgba(230, 238, 245, 0.04);
        }

        body.light-mode {
            --bg-color: var(--light-bg);
            --card-bg: var(--light-card);
            --text-color: var(--light-text);
            --border-color: var(--light-border);
            --hover-bg: rgba(0, 0, 0, 0.02);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        *::-webkit-scrollbar {
            width: 0px;
            height: 0px;
            background: transparent;
        }

        html, body {
            height: 100%;
            overflow-x: hidden;
        }

        body {
            background: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        /* Top Navigation Bar */
        .navbar {
            background: linear-gradient(180deg, #622347 0%, #4a1935 100%);
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            min-height: 56px;
        }

        .navbar-title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.5px;
            flex: 1;
            text-align: center;
        }

        .navbar-btn {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: var(--transition);
        }

        .navbar-btn:active {
            background: rgba(255,255,255,0.25);
            transform: scale(0.95);
        }

        /* Tab Navigation */
        .tab-bar {
            display: flex;
            gap: 0;
            border-top: 1px solid var(--border-color);
            background: var(--card-bg);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        .tab-bar::-webkit-scrollbar {
            height: 3px;
        }

        .tab-bar::-webkit-scrollbar-thumb {
            background: rgba(98, 35, 71, 0.3);
            border-radius: 3px;
        }

        .tab-item {
            flex: 0 0 auto;
            padding: 12px 14px;
            border: none;
            background: transparent;
            color: var(--text-color);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            white-space: nowrap;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .tab-item.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: rgba(98, 35, 71, 0.05);
        }

        .tab-item:active {
            background: var(--hover-bg);
        }

        /* Page Container */
        .page-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 12px;
            padding-bottom: calc(80px + env(safe-area-inset-bottom));
            display: none;
        }

        .page-container.active {
            display: block;
        }

        .page-content {
            max-width: 600px;
            margin: 0 auto;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .card:active {
            box-shadow: var(--shadow-md);
        }

        .card-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 14px;
            background: var(--card-bg);
            color: var(--text-color);
            transition: var(--transition);
            -webkit-appearance: none;
            appearance: none;
            -moz-appearance: none;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(98, 35, 71, 0.1);
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23428d92' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 32px;
            background-size: 14px;
        }

        /* Buttons */
        button, input[type="button"], input[type="submit"], .btn {
            padding: 11px 16px;
            border-radius: 8px;
            border: none;
            background: linear-gradient(180deg, var(--primary) 0%, #2b7f84 100%);
            color: white;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: transform 0.12s ease, box-shadow 0.12s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.12), 0 10px 20px rgba(0, 0, 0, 0.06);
            -webkit-tap-highlight-color: transparent;
            width: 100%;
            margin-bottom: 8px;
        }

        button:active, input[type="button"]:active, input[type="submit"]:active, .btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.12) inset;
        }

        button.success {
            background: linear-gradient(180deg, var(--success) 0%, #0f8a35 100%);
        }

        button.danger {
            background: linear-gradient(180deg, var(--danger) 0%, #b91c1c 100%);
        }

        button.warning {
            background: linear-gradient(180deg, var(--warning) 0%, #d97706 100%);
        }

        button.small {
            padding: 8px 12px;
            font-size: 12px;
            width: auto;
            margin-bottom: 0;
        }

        /* Stat Cards */
        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            margin: 6px 0;
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-color);
            opacity: 0.75;
        }

        /* Tables (simplified for mobile) */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 8px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
        }

        /* Ensure tables inside table-container can be scrolled horizontally on small screens */
        .table-container table {
            min-width: 520px;
            white-space: nowrap;
        }

        /* show a small scrollbar for horizontal scrolling inside .table-container */
        .table-container::-webkit-scrollbar { height: 6px; }
        .table-container::-webkit-scrollbar-thumb { background: rgba(98,35,71,0.3); border-radius: 4px; }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            padding: 10px;
            background: var(--hover-bg);
            font-weight: 700;
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
            border-bottom: 2px solid var(--border-color);
        }

        td {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: var(--hover-bg);
        }

        /* Alert Messages */
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 13px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert.success {
            background: rgba(22, 163, 74, 0.1);
            color: var(--success);
            border: 1px solid rgba(22, 163, 74, 0.2);
        }

        .alert.danger {
            background: rgba(220, 38, 38, 0.1);
            color: var(--danger);
            border: 1px solid rgba(220, 38, 38, 0.2);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 16px;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(100%);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 16px 16px 0 0;
            padding: 16px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Product Item in Lists */
        .product-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .product-info {
            flex: 1;
        }

        .product-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-color);
        }

        .product-meta {
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.7;
            margin-top: 2px;
        }

        .product-price {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
            text-align: right;
        }

        /* Low Stock Badge */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            margin-top: 4px;
        }

        .badge.low-stock {
            background: rgba(220, 38, 38, 0.1);
            color: var(--danger);
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            bottom: 70px;
            right: 12px;
            z-index: 500;
        }

        .theme-toggle-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            -webkit-tap-highlight-color: transparent;
        }

        .theme-toggle-btn:active {
            transform: scale(0.9);
        }

        /* Floating Action Buttons */
        .fab {
            position: fixed;
            bottom: calc(20px + env(safe-area-inset-bottom));
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 99;
            transition: var(--transition);
            -webkit-tap-highlight-color: transparent;
        }

        .fab:active {
            transform: scale(0.9);
        }

        /* Responsive Grid */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* Quantity Control */
        .qty-control {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .qty-control button {
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: 6px;
            font-size: 16px;
            margin-bottom: 0;
        }

        .qty-control input {
            width: 50px;
            text-align: center;
            padding: 6px;
            font-size: 13px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-color);
            opacity: 0.6;
        }

        .empty-state-icon {
            font-size: 40px;
            margin-bottom: 12px;
        }

        /* Scrollable Area */
        .list-container {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            max-height: 400px;
        }

        /* Sidebar Menu */
        .menu-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            z-index: 999;
            display: none;
        }

        .menu-modal.active {
            display: flex;
        }

        .menu-content {
            background: var(--card-bg);
            width: 280px;
            height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 12px 0;
            display: flex;
            flex-direction: column;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .menu-item {
            padding: 14px 16px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-color);
            text-align: left;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: var(--transition);
            border-left: 3px solid transparent;
            width: 100%;
        }

        .menu-item:active {
            background: var(--hover-bg);
        }

        .menu-item.active {
            background: rgba(98, 35, 71, 0.1);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        /* Safe Area Inset */
        @supports (padding: max(0px)) {
            .navbar {
                padding-top: max(12px, env(safe-area-inset-top));
                padding-left: max(12px, env(safe-area-inset-left));
                padding-right: max(12px, env(safe-area-inset-right));
            }

            .page-container {
                padding-bottom: max(12px, env(safe-area-inset-bottom));
            }
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-2 {
            margin-top: 12px;
        }

        .mb-2 {
            margin-bottom: 12px;
        }

        .text-sm {
            font-size: 12px;
        }

        .text-muted {
            color: var(--text-color);
            opacity: 0.7;
        }
    </style>
</head>
<body class="dark-mode">
    <!-- Navigation Bar -->
    
    <!-- Small menu button placed below header -->
    <div class="navbar">
        <button id="menu-btn-small" class="navbar-btn small" style="padding: 8px 12px;">‚ò∞</button>
        <div class="navbar-title">Mudi Manager</div>
        <div style="width: 48px;"></div>
    </div>

    <!-- Tab Navigation removed (menu modal used instead) -->

    <!-- Menu Modal -->
    <div class="menu-modal" id="menu-modal">
        <div class="menu-content" id="menu-content">
            <button class="menu-item active" data-page="dashboard">üìä Dashboard</button>
            <button class="menu-item" data-page="inventory">üì¶ Inventory</button>
            <button class="menu-item" data-page="product-list">üìã Products</button>
            <button class="menu-item" data-page="purchases">üßæ Purchases</button>
            <button class="menu-item" data-page="owner-draw">üí∏ Owner Draw</button>
            <button class="menu-item" data-page="pos">üí≥ Point of Sale</button>
            <button class="menu-item" data-page="sales">üìú Sales History</button>
            <button class="menu-item" data-page="reports">üìà Reports</button>
            <button class="menu-item" data-page="credits">üí∞ Credits</button>
            <button class="menu-item" data-page="credit-customers">üë• Customers</button>
            <hr style="border: none; border-top: 1px solid var(--border-color); margin: 12px 0;">
            <button class="menu-item" id="theme-toggle-menu">üåô Dark Mode</button>
        </div>
    </div>

    <!-- Pages -->
    
    <!-- Dashboard Page -->
    <div class="page-container active" id="page-dashboard">
        <div class="page-content">
            <div class="card">
                <div class="card-title">üìä Today's Summary</div>
                <div class="grid-2">
                    <div class="stat-card">
                        <div class="stat-label">Sales</div>
                        <div class="stat-value" id="dash-sales">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Revenue</div>
                        <div class="stat-value" id="dash-revenue">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Profit</div>
                        <div class="stat-value" id="dash-profit">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Products</div>
                        <div class="stat-value" id="dash-products">0</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìà Sales Trend</div>
                <canvas id="dashChart" style="max-height: 250px;"></canvas>
            </div>

            <div class="card">
                <div class="card-title">üî• Top Products</div>
                <div id="top-products-list"></div>
            </div>

            <div class="card">
                <div class="card-title">‚è∞ Recent Sales</div>
                <div id="recent-sales-list"></div>
            </div>
        </div>
    </div>

    <!-- Inventory Page -->
    <div class="page-container" id="page-inventory">
        <div class="page-content">
            <div class="card">
                <div class="card-title">‚ûï Add Product</div>
                <form id="inventory-form">
                    <div class="form-group">
                        <label>Product Name *</label>
                        <input type="text" id="inv-name" required placeholder="">
                    </div>
                    <div class="form-group">
                        <label>Barcode *</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="inv-barcode" required style="flex: 1;" placeholder="">
                            <button type="button" class="btn small" id="scan-inv-btn" style="flex: 0 0 auto; width: auto; margin-bottom: 0;">üì∑</button>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr 120px;gap:8px;">
                        <div class="form-group">
                            <label>Purchase Price</label>
                            <input type="number" id="inv-purchase-price" step="0.01" placeholder="">
                        </div>
                        <div class="form-group">
                            <label>Selling Price</label>
                            <input type="number" id="inv-selling-price" step="0.01" placeholder="">
                        </div>
                        <div class="form-group">
                            <label>Initial Quantity</label>
                            <input type="number" id="inv-qty" min="0" value="1" placeholder="1">
                        </div>
                    </div>

                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-top:6px;">
                        <div class="form-group">
                            <label>Seller / Company</label>
                            <input type="text" id="inv-seller" placeholder="Company name (optional)">
                        </div>
                        <div class="form-group">
                            <label>SR Name</label>
                            <input type="text" id="inv-sr" placeholder="Sales rep name (optional)">
                        </div>
                        <div class="form-group">
                            <label>Payment Type</label>
                            <select id="inv-payment-type">
                                <option>Cash</option>
                                <option>Credit</option>
                                <option>Bank Transfer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Record in Purchase Details?</label>
                            <select id="inv-record-purchase">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top:6px;">
                        <label>Invoice Image</label>
                        <input type="file" id="inv-invoice" accept="image/*" style="width:100%;padding:8px;border-radius:8px;">
                    </div>

                    <button type="submit" class="success" style="display:inline-flex;align-items:center;gap:8px;width:auto;padding:10px 16px;margin-top:6px;">‚ûï Add Product</button>
                </form>
            </div>

            <div class="card" style = "display: none;">
                <div class="card-title">üì¶ Current Inventory</div>
                <input type="text" id="inv-search" placeholder="Search product..." style="margin-bottom: 10px;">
                <div id="inventory-list"></div>
            </div>
        </div>
    </div>

    <!-- Product List Page -->
    <div class="page-container" id="page-product-list">
        <div class="page-content">
            <div class="card">
                <div class="card-title">üìã Product List</div>
                <div class="table-container">
                    <table id="product-list-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Barcode</th>
                                <th>Cost</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="product-list-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchases Page -->
    <div class="page-container" id="page-purchases">
        <div class="page-content">
            <div class="card" style="padding-bottom:8px;">
                <div class="card-title" style="display:flex;align-items:center;gap:8px;">
                    <span>üì¶ Purchase Details</span>
                </div>

                <style>
                    /* Purchase details specific styles */
                    .purchase-panel{display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap;margin-top:8px}
                    .purchase-summary{flex:1 1 240px;border-radius:10px;padding:18px;border:1px solid var(--border-color);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));}
                    .purchase-summary .label{font-size:12px;color:var(--text-color);opacity:0.8;text-transform:uppercase;font-weight:700}
                    .purchase-summary .amount{font-size:28px;font-weight:800;color:var(--primary);margin-top:6px}
                    .purchase-controls{display:flex;gap:8px;align-items:center;flex:0 0 220px;justify-content:flex-end}
                    .compact-control{display:flex;gap:8px;align-items:center}
                    .purchases-table-wrap{margin-top:14px;border-radius:12px;overflow:hidden;border:1px solid var(--border-color)}
                    .purchases-table-wrap thead th{background:#f8fafc;color:#0f172a;font-weight:800;font-size:12px}
                    .purchases-table-wrap tbody td{background: var(--card-bg);color:var(--text-color)}
                    .empty-purchases-row td{padding:28px;text-align:center;color:var(--text-color);opacity:0.75}
                    @media(max-width:520px){ .purchase-controls{flex:1 1 100%;justify-content:flex-start} }
                </style>

                <div class="purchase-panel">
                    <div class="purchase-summary">
                        <div class="label">Total Purchased Amount</div>
                        <div class="amount" id="purchases-total">0.00</div>
                        <div class="text-sm text-muted" style="margin-top:6px;">Sum of purchases in the selected range</div>
                    </div>

                    <div class="purchase-controls">
                        <div class="compact-control" style="gap:10px;">
                            <div style="min-width:120px;">
                                <label style="display:block;font-size:11px;margin-bottom:6px;text-transform:uppercase;color:var(--text-color);opacity:0.7">Range</label>
                                <select id="purchases-range" style="padding:8px 10px;border-radius:8px;">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div style="min-width:120px;">
                                <label style="display:block;font-size:11px;margin-bottom:6px;text-transform:uppercase;color:var(--text-color);opacity:0.7">Date</label>
                                <input type="date" id="purchases-date" style="padding:8px 10px;border-radius:8px;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="purchases-table-wrap table-container" style="margin-top:12px;">
                    <table id="purchases-table">
                        <thead>
                            <tr>
                                <th>DATE</th>
                                <th>COMPANY</th>
                                <th>SR</th>
                                <th>PRODUCT</th>
                                <th>BARCODE</th>
                                <th>QTY</th>
                                <th>UNIT COST</th>
                                <th>TOTAL COST</th>
                                <th>INVOICE</th>
                                <th>PAYMENT</th>
                            </tr>
                        </thead>
                        <tbody id="purchases-table-body">
                            <tr class="empty-purchases-row"><td colspan="10">No purchase records</td></tr>
                        </tbody>
                    </table>
                </div>

                <div id="purchases-list" style="display:none;"></div>
            </div>
        </div>
    </div>

    <!-- Owner Draw Page -->
    <div class="page-container" id="page-owner-draw">
        <div class="page-content">
            <div class="card" style="padding-bottom:8px;">
                <div class="card-title" style="display:flex;align-items:center;gap:8px;">
                    <span>üí∏ Owner Draw</span>
                </div>

                <style>
                    /* Owner draw panel styles */
                    .od-panel{display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap;margin-top:8px}
                    .od-summary{flex:1 1 260px;padding:16px;border-radius:10px;border:1px solid var(--border-color);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));}
                    .od-summary .label{font-size:12px;color:var(--text-color);opacity:0.8;text-transform:uppercase;font-weight:700}
                    .od-summary .amount{font-size:28px;font-weight:800;color:var(--primary);margin-top:6px}
                    .od-controls{display:flex;gap:8px;align-items:center;flex:0 0 380px;justify-content:flex-end}
                    .od-table-wrap{margin-top:14px;border-radius:12px;overflow:hidden;border:1px solid var(--border-color)}
                    .od-table-wrap thead th{background:#f8fafc;color:#0f172a;font-weight:800;font-size:12px}
                    .od-table-wrap tbody td{background: var(--card-bg);color:var(--text-color)}
                    .empty-od-row td{padding:28px;text-align:center;color:var(--text-color);opacity:0.75}
                    @media(max-width:520px){ .od-controls{flex:1 1 100%;justify-content:flex-start} }
                </style>

                <div class="od-panel">
                    <div class="od-summary">
                        <div class="label">Total Owner Draw Value</div>
                        <div class="amount" id="owner-draw-total">$0.00</div>
                        <div class="text-sm text-muted" style="margin-top:6px;">Cumulative value of recorded owner draws</div>
                    </div>

                    <div class="od-controls">
                        <div style="min-width:120px;">
                            <label style="display:block;font-size:11px;margin-bottom:6px;text-transform:uppercase;color:var(--text-color);opacity:0.7">Range</label>
                            <select id="owner-draw-range" style="padding:8px 10px;border-radius:8px;">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div style="min-width:140px;">
                            <label style="display:block;font-size:11px;margin-bottom:6px;text-transform:uppercase;color:var(--text-color);opacity:0.7">Date</label>
                            <input type="date" id="owner-draw-date" style="padding:8px 10px;border-radius:8px;" value="">
                        </div>
                        <div style="display:flex;gap:8px;align-items:center;margin-left:8px;">
                            <button id="owner-draw-clear-btn" class="danger small">Clear</button>
                            <button id="owner-draw-archive-btn" class="btn small" style="background:linear-gradient(90deg,#3b82f6,#7c3aed);color:white;">View Archive</button>
                        </div>
                    </div>
                </div>

                <!-- Record Owner Draw form (placed above table) -->
                <div class="card" style="margin-top:12px;padding:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
                        <div style="flex:1 1 220px;min-width:220px;">
                            <div style="font-weight:700;color:var(--text-color);">Record Owner Draw</div>
                            <hr style="border:none;border-top:1px solid var(--border-color);margin:8px 0;" />
                            <div style="font-size:13px;color:var(--text-color);opacity:0.8;">
                                <div>Profit available: <span id="od-profit-available">$0.00</span></div>
                                <div>Already drawn: <span id="od-already-drawn">$0.00</span></div>
                                <div>Remaining profit: <span id="od-remaining-profit">$0.00</span></div>
                            </div>
                        </div>

                        <form id="owner-draw-form" style="flex:1 1 320px;min-width:260px;display:flex;flex-direction:column;gap:8px;">
                            <label style="font-size:12px;font-weight:700;color:var(--text-color);">DRAW TYPE</label>
                            <select id="owner-draw-type" style="padding:10px;border-radius:8px;">
                                <option value="product">Product (remove from inventory)</option>
                                <option value="cash">Cash</option>
                            </select>

                            <label style="font-size:12px;font-weight:700;color:var(--text-color);">PRODUCT</label>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <select id="owner-draw-product" style="flex:1;padding:10px;border-radius:8px;">
                                </select>
                                <button type="button" id="owner-draw-product-edit" class="small" style="background:#f59e0b;color:#fff;border-radius:8px;padding:8px 10px;border:none;">‚úèÔ∏è</button>
                            </div>

                            <label style="font-size:12px;font-weight:700;color:var(--text-color);">QUANTITY</label>
                            <input type="number" id="owner-draw-quantity" value="1" step="1" style="padding:10px;border-radius:8px;">

                            <label style="font-size:12px;font-weight:700;color:var(--text-color);">NOTE (OPTIONAL)</label>
                            <textarea id="owner-draw-note" rows="2" style="padding:8px;border-radius:8px;"></textarea>

                            <div style="display:flex;justify-content:flex-end;">
                                <button type="submit" class="" style="background:#f59e0b;color:#fff;border-radius:8px;padding:10px 14px;border:none;font-weight:700;">Record Draw</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="od-table-wrap table-container" style="margin-top:12px;">
                    <table id="owner-draw-table">
                        <thead>
                            <tr>
                                <th>DATE</th>
                                <th>PRODUCT</th>
                                <th>QTY</th>
                                <th>UNIT</th>
                                <th>TOTAL</th>
                                <th>LOSS</th>
                                <th>NOTE</th>
                            </tr>
                        </thead>
                        <tbody id="owner-draw-table-body">
                            <tr class="empty-od-row"><td colspan="7">No owner draws recorded</td></tr>
                        </tbody>
                    </table>
                </div>

                <div id="owner-draw-list" style="display:none;"></div>
            </div>
            
            <!-- Archive Modal for Owner Draws -->
            <div class="modal" id="owner-draw-archive-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">Owner Draw Archive</div>
                        <button class="close-btn" id="close-owner-draw-archive">‚úï</button>
                    </div>
                    <div id="owner-draw-archive-list" style="max-height:60vh;overflow:auto;padding-top:8px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Credit Customers Page -->
    <div class="page-container" id="page-credit-customers">
        <div class="page-content">
            <div class="card">
                <div class="card-title">üë• Credit Customers</div>
                <div id="credit-customers-list"></div>
            </div>
        </div>
    </div>

    <!-- POS Page -->
    <div class="page-container" id="page-pos">
        <div class="page-content">
            <div class="card">
                <div class="card-title">üõí Quick Sale</div>
                <div class="form-group">
                    <label>Barcode</label>
                    <input type="text" id="pos-barcode" placeholder="Scan or enter barcode">
                    <button type="button" class="btn small" id="pos-scan-btn">üì∑ Scan</button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üõçÔ∏è Cart</div>
                <div id="pos-cart-list"></div>
                <div style="padding: 12px; background: var(--hover-bg); border-radius: 8px; text-align: right;">
                    <div style="font-size: 12px; color: var(--text-color); opacity: 0.7;">Total:</div>
                    <div style="font-size: 22px; font-weight: 800; color: var(--primary);" id="pos-total">$0.00</div>
                </div>
                <button class="success mt-2" id="complete-pos-sale">‚úÖ Complete Sale</button>
                <button class="warning mt-2" id="credit-pos-sale">üí≥ Credit Sale</button>
                <button class="danger small mt-2" id="clear-pos-cart">Clear</button>
            </div>
        </div>
    </div>

    <!-- Sales Page -->
    <div class="page-container" id="page-sales">
        <div class="page-content">
            <div class="card">
                <div class="card-title" style="display:flex;align-items:center;gap:8px;">
                    <span>üìú Sales History</span>
                    <button id="open-payment-history" class="small" style="margin-left:auto;width:auto;">View Payments</button>
                </div>
                <div id="sales-list"></div>
            </div>
        </div>
    </div>

    <!-- Credits Page -->
    <div class="page-container" id="page-credits">
        <div class="page-content">
            <div class="card">
                <div class="card-title">‚ûï New Credit Sale</div>
                <div class="form-group">
                    <label>Customer Name *</label>
                    <input type="text" id="credit-customer" required>
                </div>
                <div class="form-group">
                    <label>Mobile</label>
                    <input type="tel" id="credit-mobile" placeholder="01XXXXXXXXX">
                </div>
                <div class="form-group">
                    <label>Barcode</label>
                    <input type="text" id="credit-barcode" placeholder="Scan or enter barcode">
                    <button type="button" class="btn small" id="credit-scan-btn">üì∑ Scan</button>
                </div>
                <button type="button" class="btn small success" id="add-credit-item">‚ûï Add Item</button>
            </div>

            <div class="card">
                <div class="card-title">üõí Credit Items</div>
                <div id="credit-items-list"></div>
                <div style="padding: 12px; background: var(--hover-bg); border-radius: 8px; text-align: right; margin-bottom: 10px;">
                    <div style="font-size: 12px; color: var(--text-color); opacity: 0.7;">Total:</div>
                    <div style="font-size: 22px; font-weight: 800; color: var(--primary);" id="credit-total">$0.00</div>
                </div>
                <button class="success" id="save-credit">‚úÖ Save Credit</button>
            </div>

            <div class="card">
                <div class="card-title">üìã Credit Records</div>
                <input type="text" id="credit-search" placeholder="Search customer..." style="margin-bottom: 10px;">
                <div id="credits-list"></div>
            </div>
        </div>
    </div>

    <style>
        /* Reports visual adjustments: ensure uniform metric boxes and alignment */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            align-items: stretch;
        }

        .metric-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            min-height: 110px;
            box-sizing: border-box;
        }

        .metric-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 6px;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-color);
            margin-bottom: 6px;
        }

        .metric-subtitle {
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.6;
        }

        .net-profit-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-top: 8px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .net-profit-card .metric-value { font-size: 22px; color: var(--success); }

        @media (max-width: 900px) {
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 480px) {
            .metrics-grid { grid-template-columns: 1fr; }
        }
    </style>

    <style>
        /* Transactions layout tweaks */
        .transactions-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
            box-sizing: border-box;
            min-height: 160px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .transactions-section .section-title {
            margin: 0 0 8px 0;
        }

        .transactions-section table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-size: 13px;
        }

        .transactions-section th,
        .transactions-section td {
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 8px 6px;
            border-bottom: 1px dashed var(--border-color);
        }

        /* Column widths: date | product | qty | total */
        .transactions-section td:nth-child(1) { width: 30%; }
        .transactions-section td:nth-child(2) { width: 45%; white-space: normal; }
        .transactions-section td:nth-child(3) { width: 12%; text-align:center; }
        .transactions-section td:nth-child(4) { width: 13%; text-align:right; }

        @media (max-width: 900px) {
            .transactions-section td:nth-child(1) { width: 35%; }
            .transactions-section td:nth-child(2) { width: 40%; }
            .transactions-section td:nth-child(3) { width: 12%; }
            .transactions-section td:nth-child(4) { width: 13%; }
            .transactions-section td:nth-child(2) { white-space: normal; }
        }
        /* Grid wrapper to ensure both transaction columns align and share equal height */
        .transactions-grid {
            display: flex;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 12px;
            align-items: start;
            grid-auto-rows: 1fr;
        }

        .transactions-grid > .transactions-section {
            height: 100%;
        }
    </style>

    <!-- Reports Page -->
    <div class="page-container" id="page-reports">
        <div class="page-content">
            <div class="card">
                <div class="card-title">üìà Reports</div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="report-date">
                </div>
                <div class="form-group">
                    <label>Range</label>
                    <select id="report-range">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button class="success" id="generate-report">üìä Generate Report</button>
                    <button class="small" id="download-pdf">üì• Download PDF</button>
                </div>
            </div>

            <div class="card" id="report-output"></div>

            <div class="card">
                <button class="small" id="export-btn">üíæ Export Backup</button>
                <button class="small" id="import-btn">üì• Import Backup</button>
                <input type="file" id="import-file" accept="application/json" style="display: none;">
            </div>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div class="modal" id="scanner-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üì∑ Scan Barcode</div>
                <button class="close-btn" id="close-scanner">‚úï</button>
            </div>
            <div id="scanner-container" style="width: 100%; height: 300px; background: #000; border-radius: 8px; margin-bottom: 12px;"></div>
            <div id="scanner-debug" style="font-size:12px;color:var(--text-color);opacity:0.9;max-height:80px;overflow:auto;">&nbsp;</div>
            <div class="form-group">
                <label>Manual Entry</label>
                <input type="text" id="manual-barcode">
            </div>
            <button class="success small" id="use-barcode">‚úÖ Use Barcode</button>
        </div>
    </div>

        <!-- Credit Payment Modal -->
        <div class="modal" id="credit-pay-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">üí≥ Receive Payment</div>
                    <button class="close-btn" id="close-credit-pay">‚úï</button>
                </div>
                <div style="margin-bottom:12px;">
                    <div style="font-weight:700;font-size:16px;" id="credit-pay-customer">Customer</div>
                    <div style="color:var(--text-color);opacity:0.8;" id="credit-pay-total">Total unpaid: $0.00</div>
                </div>
                <div id="credit-pay-list" style="max-height:240px;overflow:auto;margin-bottom:12px;"></div>

                <div style="display:flex;gap:8px;justify-content:center;margin-bottom:8px;">
                    <button id="credit-pay-full" class="success">Full Paid</button>
                    <button id="credit-pay-custom" class="small">Custom Paid</button>
                </div>

                <div id="credit-pay-custom-row" style="display:none;margin-top:8px;">
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="credit-pay-amount" step="0.01" min="0" placeholder="0.00">
                    </div>
                    <div style="display:flex;gap:8px;justify-content:flex-end;">
                        <button id="credit-pay-custom-confirm" class="success">Pay</button>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Edit Product Modal -->
        <div class="modal" id="edit-product-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">‚úèÔ∏è Edit Product</div>
                    <button class="close-btn" id="close-edit-product">‚úï</button>
                </div>
                <form id="edit-product-form">
                    <div class="form-group"><label>Product Name</label><input type="text" id="edit-prod-name" readonly></div>
                    <div class="form-group"><label>Barcode</label><input type="text" id="edit-prod-barcode" readonly></div>
                    <div class="form-group"><label>Purchase Price</label><input type="number" id="edit-prod-purchase" step="0.01" required></div>
                    <div class="form-group"><label>Selling Price</label><input type="number" id="edit-prod-selling" step="0.01" required></div>
                    <div class="form-group"><label>Current Stock</label><input type="number" id="edit-prod-current" readonly></div>
                    <div class="form-group"><label>Add Stock</label><input type="number" id="edit-prod-add" min="0" value="0"></div>
                    <div class="form-group"><label><input type="checkbox" id="edit-prod-record-purchase"> Record added stock as purchase</label></div>
                    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
                        <button type="button" class="btn" id="delete-product-confirm" style="background:linear-gradient(180deg,#dc2626 0%,#b91c1c 100%);">Delete</button>
                        <button type="submit" class="success">Save</button>
                    </div>
                </form>
            </div>
        </div>

    <!-- Theme Toggle Button -->
        <!-- Table Detail Modal (opens full-width table on click) -->
        <div class="modal" id="table-detail-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="table-detail-title">Table Details</div>
                    <button class="close-btn" id="close-table-detail">‚úï</button>
                </div>
                <div id="table-detail-content" style="padding-top:8px;">
                    <!-- cloned table will be inserted here -->
                </div>
            </div>
        </div>
    <div class="theme-toggle">
        <button class="theme-toggle-btn" id="theme-toggle" title="Toggle theme">üåô</button>
    </div>

    <!-- App Confirm Modal -->
    <div class="modal" id="app-confirm-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Confirm</div>
                <button class="close-btn" id="app-confirm-close">‚úï</button>
            </div>
            <div style="padding:8px 0; font-size:15px;" id="app-confirm-message">Are you sure?</div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
                <button id="app-confirm-no" class="btn small">No</button>
                <button id="app-confirm-yes" class="success small">Yes</button>
            </div>
        </div>
    </div>

    <!-- Payment History Modal -->
    <div class="modal" id="payment-history-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Payment History</div>
                <button class="close-btn" id="close-payment-history">‚úï</button>
            </div>
            <div id="payment-history-list" style="max-height:60vh;overflow:auto;padding-top:8px;"></div>
        </div>
    </div>

    <!-- FAB -->
    <button class="fab" id="quick-pos" title="Quick POS">‚ö°</button>

    <script>
        // Global data
        let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
        let sales = JSON.parse(localStorage.getItem('sales')) || [];
        let credits = JSON.parse(localStorage.getItem('credits')) || [];
        let purchases = JSON.parse(localStorage.getItem('purchases')) || [];
        let paymentHistory = JSON.parse(localStorage.getItem('paymentHistory')) || [];
        let ownerDraws = JSON.parse(localStorage.getItem('ownerDraws')) || [];
        let lowStockThreshold = parseInt(localStorage.getItem('lowStockThreshold')) || 5;

        let currentCart = [];
        let creditCart = [];
        // legacy/compat alias for older snippets that expect `cart`
        let cart = currentCart;
        let html5QrCode = null;
        let scannerActive = false;
        let scannerMode = '';
        let _dashboardTimer = null;

        // renderCart is a compatibility wrapper that updates the POS cart UI
        function renderCart() {
            try { updateCartDisplay(); } catch (e) { /* ignore */ }
        }

        // removeFromCart alias for older handlers
        window.removeFromCart = (idx) => { window.removeCartItem?.(idx); };

        // Helper functions
        function saveData() {
            localStorage.setItem('inventory', JSON.stringify(inventory));
            localStorage.setItem('sales', JSON.stringify(sales));
            localStorage.setItem('credits', JSON.stringify(credits));
            localStorage.setItem('purchases', JSON.stringify(purchases));
            localStorage.setItem('paymentHistory', JSON.stringify(paymentHistory));
            localStorage.setItem('ownerDraws', JSON.stringify(ownerDraws));
            // schedule a debounced dashboard refresh so UI updates in near-real-time
            try { scheduleDashboardUpdate(); } catch (e) {}
        }

        function scheduleDashboardUpdate(delay = 150) {
            try {
                if (_dashboardTimer) clearTimeout(_dashboardTimer);
                _dashboardTimer = setTimeout(() => {
                    try { updateDashboard(); } catch (e) {}
                }, delay);
            } catch (e) {}
        }

        // Deduplicate inventory by barcode: merge quantities and prefer latest entry for prices/name
        function dedupeInventory() {
            if (!Array.isArray(inventory) || inventory.length === 0) return;
            const originalLen = inventory.length;
            const map = {};
            const noBarcode = [];
            inventory.forEach(item => {
                const key = (item.barcode || '').toString().trim();
                if (!key) { noBarcode.push(item); return; }
                if (!map[key]) {
                    map[key] = Object.assign({}, item);
                } else {
                    // sum quantities
                    map[key].quantity = Number(map[key].quantity || 0) + Number(item.quantity || 0);
                    // prefer latest id for name/prices
                    if (Number(item.id || 0) > Number(map[key].id || 0)) {
                        map[key].name = item.name || map[key].name;
                        map[key].purchasePrice = item.purchasePrice || map[key].purchasePrice;
                        map[key].sellingPrice = item.sellingPrice || map[key].sellingPrice;
                        map[key].id = item.id || map[key].id;
                    }
                }
            });
            const merged = Object.values(map).concat(noBarcode);
            if (merged.length !== originalLen) {
                inventory = merged;
                saveData();
            }
        }

        function getBaseCurrency(){
            try{
                const a = JSON.parse(localStorage.getItem('mudiManagerProfile') || 'null');
                const b = JSON.parse(localStorage.getItem('userProfile') || 'null');
                return (a && a.currency) || (b && b.currency) || '$';
            }catch(e){ return '$'; }
        }

        function formatCurrency(val){
            const curr = getBaseCurrency() || '$';
            const n = Number(val || 0);
            return curr + n.toFixed(2);
        }

        // simple HTML escaper for injected values
        function escapeHtml(s){
            return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
        }

        function showAlert(message, type = 'success', containerId) {
            // Prefer global in-app alert renderer if available (desktop file provides `appAlert`)
            if (window.appAlert) { try{ window.appAlert(String(message), type); return; }catch(e){} }

            const div = document.createElement('div');
            div.className = `alert ${type}`;
            div.innerHTML = `<span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span><span>${message}</span>`;
            const container = containerId ? document.getElementById(containerId) : document.querySelector('.page-container.active');
            if (container) {
                container.insertBefore(div, container.firstChild);
                setTimeout(() => div.remove(), 3000);
            }
        }

        // In-app confirmation modal helper. Returns a Promise<boolean>.
        function appConfirm(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('app-confirm-modal');
                const msg = document.getElementById('app-confirm-message');
                const yes = document.getElementById('app-confirm-yes');
                const no = document.getElementById('app-confirm-no');
                if (!modal || !msg || !yes || !no) {
                    // fallback to native confirm if modal is missing
                    try { resolve(confirm(String(message))); } catch (e) { resolve(false); }
                    return;
                }
                msg.textContent = String(message || 'Are you sure?');
                modal.classList.add('active');

                function cleanup() {
                    modal.classList.remove('active');
                    yes.removeEventListener('click', onYes);
                    no.removeEventListener('click', onNo);
                }

                function onYes() { cleanup(); resolve(true); }
                function onNo() { cleanup(); resolve(false); }

                yes.addEventListener('click', onYes);
                no.addEventListener('click', onNo);
            });
        }

        // Wire the small close button on confirm modal to act like 'No'
        document.getElementById('app-confirm-close')?.addEventListener('click', () => {
            document.getElementById('app-confirm-no')?.click();
        });

        // expose as global for compatibility
        window.appConfirm = appConfirm;

        // Navigation
        document.querySelectorAll('.tab-item, .menu-item').forEach(btn => {
            btn.addEventListener('click', function() {
                const page = this.getAttribute('data-page');
                if (!page) return;
                
                // Update active states
                document.querySelectorAll('.tab-item, .menu-item').forEach(b => b.classList.remove('active'));
                document.querySelector(`.tab-item[data-page="${page}"]`)?.classList.add('active');
                document.querySelector(`.menu-item[data-page="${page}"]`)?.classList.add('active');
                
                // Update pages
                document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
                const target = document.getElementById(`page-${page}`);
                if (target) {
                    target.classList.add('active');
                    updatePage(page);
                }
                
                // Close menu
                document.getElementById('menu-modal').classList.remove('active');
            });
        });

        

        function updatePage(page) {
            if (page === 'dashboard') updateDashboard();
            if (page === 'inventory') displayInventory();
            if (page === 'product-list') displayInventory();
            if (page === 'sales') displaySales();
            if (page === 'credits') displayCredits();
            if (page === 'purchases') displayPurchases();
            if (page === 'owner-draw') { populateOwnerDrawProducts(); displayInventory(); displayOwnerDraws(); }
            if (page === 'credit-customers') refreshCreditCustomersList();
            if (page === 'reports') {
                document.getElementById('report-date').value = new Date().toISOString().split('T')[0];
            }
        }

        // Menu
        document.getElementById('menu-btn-small').addEventListener('click', () => {
            document.getElementById('menu-modal').classList.add('active');
        });

        document.getElementById('menu-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                document.getElementById('menu-modal').classList.remove('active');
            }
        });

        // Theme
        function setTheme(isDark) {
            document.body.className = isDark ? 'dark-mode' : 'light-mode';
            localStorage.setItem('theme', isDark ? 'dark-mode' : 'light-mode');
            const btn = document.getElementById('theme-toggle');
            btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            const menuBtn = document.getElementById('theme-toggle-menu');
            if (menuBtn) menuBtn.textContent = isDark ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
        }

        const savedTheme = localStorage.getItem('theme') || 'dark-mode';
        setTheme(savedTheme === 'dark-mode');

        document.getElementById('theme-toggle').addEventListener('click', () => {
            const isDark = document.body.classList.contains('dark-mode');
            setTheme(!isDark);
        });

        document.getElementById('theme-toggle-menu')?.addEventListener('click', () => {
            document.getElementById('menu-btn-small')?.click();
            document.getElementById('theme-toggle').click();
        });

        // Dashboard
        function updateDashboard() {
            const todayStr = new Date().toLocaleDateString();
            const todaysSales = sales.filter(s => s.dateString === todayStr);
            // Only count non-credit sales for revenue (credits are counted via paymentHistory)
            const todaysCashSales = todaysSales.filter(s => !s.isFromCredit);
            const todaysRevenue = todaysCashSales.reduce((sum, s) => sum + (Number(s.total || 0)), 0);
            // For profit, count actual cash sales AND fully-paid credits
            const todaysProfit = todaysSales.reduce((sum, s) => sum + (Number(s.totalProfit || 0)), 0);
            // include payments received today (credit payments only - unpaid portions)
            const paymentsToday = (paymentHistory || []).filter(p => {
                try{ return new Date(p.date || p.timestamp || p.createdAt || p.time).toLocaleDateString() === todayStr; }catch(e){ return false; }
            });
            const paymentsTotalToday = paymentsToday.reduce((sum,p) => sum + (Number(p.amount || 0)), 0);

            document.getElementById('dash-sales').textContent = todaysSales.length;
            document.getElementById('dash-revenue').textContent = formatCurrency(todaysRevenue + paymentsTotalToday);
            document.getElementById('dash-profit').textContent = formatCurrency(todaysProfit);
            document.getElementById('dash-products').textContent = inventory.length;

            // Chart
            const last7Days = [];
            const labels = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                labels.push(d.toLocaleDateString('en-US', { weekday: 'short' }));
                const dayStr = d.toLocaleDateString();
                const daySales = sales.filter(s => s.dateString === dayStr);
                last7Days.push(daySales.reduce((sum, s) => sum + (Number(s.total || 0)), 0));
            }

            const ctx = document.getElementById('dashChart');
            if (ctx) {
                try {
                    if (window.dashChart) window.dashChart.destroy();
                    window.dashChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels,
                            datasets: [{
                                label: 'Daily Sales',
                                data: last7Days,
                                backgroundColor: '#622347',
                                borderColor: '#4a1935',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                } catch (e) {
                    console.error('Chart error:', e);
                }
            }

            // Top Products
            const topList = document.getElementById('top-products-list');
            if (topList) {
                const products = {};
                sales.forEach(s => {
                    s.items?.forEach(item => {
                        if (!products[item.name]) products[item.name] = 0;
                        products[item.name] += item.quantity;
                    });
                });
                const sorted = Object.entries(products).sort((a, b) => b[1] - a[1]).slice(0, 5);
                topList.innerHTML = sorted.length ? sorted.map(([name, qty]) => 
                    `<div class="product-item"><span>${name}</span><span class="product-price" style="color: var(--primary);">x${qty}</span></div>`
                ).join('') : '<div class="empty-state">No sales yet</div>';
            }

            // Recent Sales
            const recentList = document.getElementById('recent-sales-list');
            if (recentList) {
                const recent = sales.slice(-5).reverse();
                recentList.innerHTML = recent.length ? recent.map(s => 
                    `<div class="product-item"><span>${new Date(s.date).toLocaleTimeString()}</span><span class="product-price">${formatCurrency(s.total)}</span></div>`
                ).join('') : '<div class="empty-state">No sales yet</div>';
            }
        }

        // Inventory
        document.getElementById('inventory-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('inv-name').value.trim();
            const barcode = document.getElementById('inv-barcode').value.trim();
            const purchase = parseFloat(document.getElementById('inv-purchase-price').value) || 0;
            const selling = parseFloat(document.getElementById('inv-selling-price').value) || 0;
            const qty = parseInt(document.getElementById('inv-qty').value) || 0;
            const seller = document.getElementById('inv-seller')?.value.trim() || '';
            const srname = document.getElementById('inv-sr')?.value.trim() || '';
            const paymentType = document.getElementById('inv-payment-type')?.value || '';
            const recordPurchase = (document.getElementById('inv-record-purchase')?.value || 'no') === 'yes';

            if (!name || !barcode) {
                showAlert('Fill product name and barcode', 'danger');
                return;
            }

            // read invoice file if present (as data url)
            const invoiceInput = document.getElementById('inv-invoice');
            let invoiceData = null;
            if (invoiceInput && invoiceInput.files && invoiceInput.files[0]) {
                try {
                    invoiceData = await new Promise((resolve, reject) => {
                        const fr = new FileReader();
                        fr.onload = () => resolve(fr.result);
                        fr.onerror = () => reject(new Error('Failed to read file'));
                        fr.readAsDataURL(invoiceInput.files[0]);
                    });
                } catch (err) { invoiceData = null; }
            }

            const existingIndex = inventory.findIndex(p => String(p.barcode) === String(barcode));
            if (existingIndex > -1) {
                const existing = inventory[existingIndex];
                document.getElementById('edit-prod-name').value = existing.name || name;
                document.getElementById('edit-prod-barcode').value = existing.barcode || barcode;
                document.getElementById('edit-prod-purchase').value = purchase || (existing.purchasePrice || 0);
                document.getElementById('edit-prod-selling').value = selling || (existing.sellingPrice || 0);
                document.getElementById('edit-prod-current').value = existing.quantity || 0;
                document.getElementById('edit-prod-add').value = qty || 0;
                const editCheckbox = document.getElementById('edit-prod-record-purchase');
                if (editCheckbox) editCheckbox.checked = recordPurchase;
                if (recordPurchase) document.getElementById('edit-product-modal').dataset.recordPurchase = '1';
                else delete document.getElementById('edit-product-modal').dataset.recordPurchase;
                document.getElementById('edit-product-modal').dataset.editId = String(existing.id);
                document.getElementById('edit-product-modal').classList.add('active');
                showAlert('Product already exists ‚Äî opened edit dialog to update it', 'warning');
            } else {
                const newId = Date.now();
                inventory.push({ id: newId, name, barcode, purchasePrice: purchase, sellingPrice: selling, quantity: qty });

                if (recordPurchase && qty > 0) {
                    purchases.push({
                        id: Date.now()+Math.floor(Math.random()*999),
                        date: (new Date()).toISOString(),
                        productId: newId,
                        productName: name,
                        barcode,
                        quantity: qty,
                        purchasePrice: purchase,
                        totalCost: Number(purchase) * qty,
                        supplier: seller,
                        srName: srname,
                        paymentType: paymentType,
                        invoiceImage: invoiceData
                    });
                }

                saveData();
                displayInventory();
                e.target.reset();
                showAlert('Product saved successfully', 'success');
            }

            saveData();
            displayInventory();
            e.target.reset();
        });

        function displayInventory(items) {
            const list = document.getElementById('inventory-list');
            const search = document.getElementById('inv-search')?.value.toLowerCase() || '';
            const filtered = items || inventory.filter(p => 
                (p.name||'').toLowerCase().includes(search) || (p.barcode||'').toLowerCase().includes(search)
            );

            // Render simple inventory list (no edit/delete here by user request)
            list.innerHTML = filtered.length ? filtered.map(p => `
                <div class="product-item" data-id="${p.id}">
                    <div class="product-info">
                        <div class="product-name">${escapeHtml(p.name)}</div>
                        <div class="product-meta">Code: ${escapeHtml(p.barcode)}</div>
                        <div class="product-meta">Stock: ${p.quantity}</div>
                        ${p.quantity <= lowStockThreshold ? '<div class="badge low-stock">‚ö†Ô∏è Low Stock</div>' : ''}
                    </div>
                    <div class="product-price">${formatCurrency(p.sellingPrice)}</div>
                </div>
            `).join('') : '<div class="empty-state">No products</div>';

            // attach edit/delete handlers
            document.querySelectorAll('.edit-product-btn').forEach(b => b.addEventListener('click', (ev) => {
                const id = ev.currentTarget.getAttribute('data-id'); openEditProductModal(id);
            }));
            document.querySelectorAll('.delete-product-btn').forEach(b => b.addEventListener('click', (ev) => {
                const id = ev.currentTarget.getAttribute('data-id'); deleteProduct(id);
            }));

            // Also populate the product-list table if present (desktop parity)
            const prodTable = document.getElementById('product-list-body');
            if (prodTable) {
                if (filtered.length === 0) {
                    prodTable.innerHTML = `<tr><td colspan="6" class="text-center">No products</td></tr>`;
                } else {
                    prodTable.innerHTML = filtered.map(p => `
                        <tr>
                            <td>${escapeHtml(p.name)}</td>
                            <td><code>${escapeHtml(p.barcode)}</code></td>
                            <td>${formatCurrency(p.purchasePrice || 0)}</td>
                            <td>${formatCurrency(p.sellingPrice || 0)}</td>
                            <td>${p.quantity}</td>
                            <td style="white-space:nowrap;">
                                <button type="button" class="btn small product-edit-btn" data-id="${p.id}" onclick="openEditProductModal('${p.id}')">Edit</button>
                                <button type="button" class="btn small product-delete-btn" data-id="${p.id}" onclick="deleteProduct('${p.id}')" style="background:linear-gradient(180deg,#dc2626 0%,#b91c1c 100%);">Delete</button>
                            </td>
                        </tr>
                    `).join('');

                    // attach delegated handlers on the table body for Edit/Delete
                    const prodBody = document.getElementById('product-list-body');
                    if (prodBody && !prodBody._delegationAdded) {
                        prodBody.addEventListener('click', (e) => {
                            const editBtn = e.target.closest('.product-edit-btn');
                            if (editBtn) { openEditProductModal(editBtn.getAttribute('data-id')); return; }
                            const delBtn = e.target.closest('.product-delete-btn');
                            if (delBtn) { deleteProduct(delBtn.getAttribute('data-id')); return; }
                        });
                        prodBody._delegationAdded = true;
                    }
                }
            }

            // populate owner-draw product select if present
            const ownerSel = document.getElementById('owner-draw-product');
            if (ownerSel) {
                ownerSel.innerHTML = inventory.map(p => `<option value="${p.id}">${escapeHtml(p.name)} (${escapeHtml(p.barcode)})</option>`).join('');
            }
            // also ensure dedicated population helper runs if present
            try { if (typeof populateOwnerDrawProducts === 'function') populateOwnerDrawProducts(); } catch(e){}
        }

        // support alternate search input id `inventory-search` if present
        document.getElementById('inventory-search')?.addEventListener('input', (e) => {
            const term = (e.target.value || '').toLowerCase();
            const filtered = inventory.filter(p => (p.name||'').toLowerCase().includes(term) || (p.barcode||'').includes(term));
            displayInventory(filtered);
        });

        // Populate owner draw product selector from inventory
        function populateOwnerDrawProducts() {
            const select = document.getElementById('owner-draw-product');
            if (!select) return;
            select.innerHTML = inventory.map(p => `
                <option value="${escapeHtml(String(p.id))}">${escapeHtml(p.name)} (${escapeHtml(p.barcode)}) ‚Äî ${p.quantity || 0}</option>
            `).join('');
        }

        // Update owner draw summary (profit available, already drawn, remaining)
        function updateOwnerDrawSummary(){
            const profitAvailable = (sales || []).reduce((s, x) => s + Number(x.totalProfit || 0), 0);
            const already = (ownerDraws || []).reduce((s, d) => s + Number(d.total || d.amount || 0), 0);
            const remaining = profitAvailable - already;
            document.getElementById('od-profit-available') && (document.getElementById('od-profit-available').textContent = formatCurrency(profitAvailable));
            document.getElementById('od-already-drawn') && (document.getElementById('od-already-drawn').textContent = formatCurrency(already));
            document.getElementById('od-remaining-profit') && (document.getElementById('od-remaining-profit').textContent = formatCurrency(remaining));
        }

        document.getElementById('inv-search')?.addEventListener('input', displayInventory);

        // Scanner
        async function openScanner(mode) {
            scannerMode = mode;
            document.getElementById('scanner-modal').classList.add('active');
            await startScanner();
        }

        async function startScanner() {
            html5QrCode = new Html5Qrcode("scanner-container");

            // Many mobile browsers require a secure context (https or localhost) to access camera.
            try {
                if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                    // Inform the user but still attempt to start - some webviews may still allow it.
                    showAlert('Camera access usually requires HTTPS or localhost. If scanning fails, open this page via HTTPS or a local server.', 'warning');
                }
            } catch (e) { /* ignore */ }

            const config = { fps: 10, qrbox: 250 };
            const onScanSuccess = (text) => {
                try { document.getElementById('manual-barcode').value = text; } catch (e) {}
                try { useBarcode(); } catch (e) {}
            };

            // Probe camera permission first to provide clearer error messages on mobile
            try {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    let probeStream = null;
                    try {
                        probeStream = await navigator.mediaDevices.getUserMedia({ video: true });
                        // stop immediately - we only needed to prompt for permission and ensure camera availability
                        probeStream.getTracks().forEach(t => t.stop());
                    } catch (permErr) {
                        // Map common errors to helpful messages
                        const name = (permErr && permErr.name) || '';
                        if (name === 'NotAllowedError' || name === 'SecurityError' || name === 'PermissionDeniedError') {
                            showAlert('Camera permission denied. Please allow camera access in Chrome site settings.', 'danger');
                        } else if (name === 'NotFoundError' || name === 'OverconstrainedError') {
                            showAlert('No camera found on this device.', 'danger');
                        } else {
                            showAlert('Unable to access camera: ' + (permErr.message || name || 'Unknown'), 'danger');
                        }
                        scannerActive = false;
                        return;
                    }
                }
            } catch (probeErr) {
                console.warn('Camera probe error', probeErr);
            }

            try {
                // Prefer selecting a camera device id (back camera) using Html5Qrcode.getCameras()
                let cameras = [];
                try { cameras = await Html5Qrcode.getCameras(); } catch (e) { cameras = []; }

                let chosen = null;
                if (cameras && cameras.length) {
                    // Heuristic: prefer label containing back/rear/environment, else pick last
                    const back = cameras.find(c => /back|rear|environment|wide|0/gi.test(c.label || ''));
                    chosen = (back && back.id) || cameras[cameras.length - 1].id;
                }

                // ensure container is visible and has layout (some Android webviews need a short delay)
                const containerEl = document.getElementById('scanner-container');
                if (containerEl && (containerEl.clientWidth === 0 || containerEl.clientHeight === 0)) {
                    await new Promise(r => setTimeout(r, 300));
                }

                const debugLog = (msg) => {
                    console.debug(msg);
                    try {
                        const dbg = document.getElementById('scanner-debug'); if (dbg) dbg.innerText = msg;
                    } catch (e) {}
                };

                let started = false;
                if (chosen) {
                    try { debugLog('Starting Html5Qrcode with deviceId'); await html5QrCode.start(chosen, config, onScanSuccess); started = true; }
                    catch (e) { debugLog('deviceId start failed: ' + (e && e.message)); }
                }

                if (!started) {
                    try { debugLog('Trying facingMode exact environment'); await html5QrCode.start({ facingMode: { exact: 'environment' } }, config, onScanSuccess); started = true; }
                    catch (e) { debugLog('facingMode exact failed: ' + (e && e.message)); }
                }

                if (!started) {
                    try { debugLog('Trying facingMode environment'); await html5QrCode.start({ facingMode: 'environment' }, config, onScanSuccess); started = true; }
                    catch (e) { debugLog('facingMode fallback failed: ' + (e && e.message)); }
                }

                if (!started) {
                    // Last resort: show raw camera preview via getUserMedia to verify camera stream
                    try {
                        debugLog('All Html5Qrcode starts failed ‚Äî falling back to raw getUserMedia preview');

                        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                            debugLog('navigator.mediaDevices.getUserMedia not available in this browser/context');
                            showAlert('Camera API unavailable in this context. Chrome on Android requires a secure origin (HTTPS) or localhost. Try using HTTPS (ngrok) or open via localhost.', 'danger');
                            scannerActive = false;
                            return;
                        }

                        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                        // create a lightweight video element inside scanner-container
                        const vid = document.createElement('video');
                        vid.autoplay = true; vid.playsInline = true; vid.muted = true; vid.style.width = '100%'; vid.style.height = '100%';
                        // clear container
                        containerEl.innerHTML = '';
                        containerEl.appendChild(vid);
                        vid.srcObject = stream;
                        scannerActive = true;
                        debugLog('Raw preview started ‚Äî scanner not available but camera works');
                        return;
                    } catch (gerr) {
                        debugLog('Raw getUserMedia fallback failed: ' + (gerr && gerr.message));
                        // provide a clearer hint if it's an insecure origin/network IP
                        showAlert('Unable to open camera preview. Ensure Chrome has camera permission and the page is served over HTTPS or localhost. For quick testing you can use ngrok to get an HTTPS URL for your server.', 'danger');
                    }
                }

                if (started) {
                    scannerActive = true;
                    debugLog('Html5Qrcode started successfully');
                } else {
                    scannerActive = false;
                    showAlert('Unable to start camera. Check Chrome site settings and that the page is served over HTTPS.', 'danger');
                }
            } catch (err) {
                console.error('Scanner start error:', err);
                showAlert('Camera not available or permission denied. Ensure the page is served over HTTPS and camera permission is granted.', 'danger');
                scannerActive = false;
            }
        }

        function stopScanner() {
            if (html5QrCode && scannerActive) {
                html5QrCode.stop();
                scannerActive = false;
            }
        }

        function useBarcode() {
            const code = document.getElementById('manual-barcode').value.trim();
            if (!code) return;

            if (scannerMode === 'inventory') {
                document.getElementById('inv-barcode').value = code;
            } else if (scannerMode === 'pos') {
                addToCart(code);
            } else if (scannerMode === 'credit') {
                addToCreditCart(code);
            }

            document.getElementById('manual-barcode').value = '';
            stopScanner();
            document.getElementById('scanner-modal').classList.remove('active');
        }

        document.getElementById('close-scanner')?.addEventListener('click', () => {
            stopScanner();
            document.getElementById('scanner-modal').classList.remove('active');
        });

        document.getElementById('use-barcode')?.addEventListener('click', useBarcode);

        document.getElementById('scan-inv-btn')?.addEventListener('click', () => openScanner('inventory'));
        document.getElementById('pos-scan-btn')?.addEventListener('click', () => openScanner('pos'));
        document.getElementById('credit-scan-btn')?.addEventListener('click', () => openScanner('credit'));

        // POS
        function addToCart(barcode) {
            const prod = inventory.find(p => p.barcode === barcode);
            if (!prod) { showAlert('Product not found', 'danger'); return; }
            if (prod.quantity <= 0) { showAlert('Out of stock', 'danger'); return; }

            const existing = currentCart.find(c => c.barcode === barcode);
            if (existing) {
                if (existing.quantity < prod.quantity) existing.quantity++;
                else { showAlert('Not enough stock', 'danger'); return; }
            } else {
                currentCart.push({ ...prod, quantity: 1 });
            }
            updateCartDisplay();
        }

        function updateCartDisplay() {
            const list = document.getElementById('pos-cart-list');
            let total = 0;
            list.innerHTML = currentCart.map((item, idx) => {
                const itemTotal = item.sellingPrice * item.quantity;
                total += itemTotal;
                return `
                    <div class="product-item">
                        <div style="flex: 1;">
                            <div class="product-name">${item.name}</div>
                            <div class="qty-control">
                                <button class="small danger" onclick="removeCartItem(${idx})">‚àí</button>
                                <input type="number" value="${item.quantity}" style="width: 50px; padding: 4px;" onchange="updateQty(${idx}, this.value)">
                                <button class="small success" onclick="addQty(${idx})">+</button>
                            </div>
                        </div>
                        <div class="product-price">${formatCurrency(itemTotal)}</div>
                    </div>
                `;
            }).join('');
            document.getElementById('pos-total').textContent = formatCurrency(total);
        }

        window.removeCartItem = (idx) => {
            currentCart.splice(idx, 1);
            updateCartDisplay();
        };

        window.updateQty = (idx, val) => {
            currentCart[idx].quantity = parseInt(val) || 1;
            updateCartDisplay();
        };

        window.addQty = (idx) => {
            currentCart[idx].quantity++;
            updateCartDisplay();
        };

        document.getElementById('pos-barcode')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addToCart(document.getElementById('pos-barcode').value.trim());
                document.getElementById('pos-barcode').value = '';
            }
        });

        document.getElementById('complete-pos-sale')?.addEventListener('click', () => {
            if (currentCart.length === 0) { showAlert('Cart is empty', 'danger'); return; }
            let totalProfit = 0;
            currentCart.forEach(item => {
                totalProfit += (item.sellingPrice - item.purchasePrice) * item.quantity;
                const prod = inventory.find(p => p.id === item.id);
                if (prod) prod.quantity -= item.quantity;
            });
            sales.push({
                id: Date.now(),
                date: new Date().toISOString(),
                dateString: new Date().toLocaleDateString(),
                items: [...currentCart],
                total: currentCart.reduce((sum, i) => sum + (i.sellingPrice * i.quantity), 0),
                totalProfit
            });
            saveData();
            currentCart = [];
            updateCartDisplay();
            updateDashboard();
            showAlert('Sale completed');
        });

        document.getElementById('clear-pos-cart')?.addEventListener('click', () => {
            currentCart = [];
            updateCartDisplay();
        });

        document.getElementById('credit-pos-sale')?.addEventListener('click', () => {
            if (currentCart.length === 0) { showAlert('Cart is empty', 'danger'); return; }
            creditCart = [...currentCart];
            currentCart = [];
            updateCartDisplay();
            updateCreditDisplay();
            // Navigate to credits page via menu (tab-bar removed)
            document.querySelectorAll('.tab-item, .menu-item').forEach(b => b.classList.remove('active'));
            document.querySelector(`.menu-item[data-page="credits"]`)?.classList.add('active');
            document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
            const creditsPage = document.getElementById('page-credits');
            if (creditsPage) { creditsPage.classList.add('active'); updatePage('credits'); }
            document.getElementById('menu-modal')?.classList.remove('active');
        });

        // Credits
        document.getElementById('add-credit-item')?.addEventListener('click', () => {
            const code = document.getElementById('credit-barcode').value.trim();
            if (!code) return;
            addToCreditCart(code);
            document.getElementById('credit-barcode').value = '';
        });

        function addToCreditCart(barcode) {
            const prod = inventory.find(p => p.barcode === barcode);
            if (!prod) { showAlert('Product not found', 'danger'); return; }
            if (prod.quantity <= 0) { showAlert('Out of stock', 'danger'); return; }

            const existing = creditCart.find(c => c.barcode === barcode);
            if (existing) {
                existing.quantity++;
            } else {
                creditCart.push({ ...prod, quantity: 1 });
            }
            updateCreditDisplay();
        }

        function updateCreditDisplay() {
            const list = document.getElementById('credit-items-list');
            let total = 0;
            list.innerHTML = creditCart.map((item, idx) => {
                const itemTotal = item.sellingPrice * item.quantity;
                total += itemTotal;
                return `
                    <div class="product-item">
                        <div style="flex: 1;">
                            <div class="product-name">${item.name}</div>
                            <div class="qty-control">
                                <button class="small danger" onclick="removeCreditItem(${idx})">‚àí</button>
                                <span style="padding: 0 8px;">${item.quantity}</span>
                                <button class="small success" onclick="addCreditQty(${idx})">+</button>
                            </div>
                        </div>
                        <div class="product-price">${formatCurrency(itemTotal)}</div>
                    </div>
                `;
            }).join('');
            document.getElementById('credit-total').textContent = formatCurrency(total);
        }

        window.removeCreditItem = (idx) => {
            creditCart.splice(idx, 1);
            updateCreditDisplay();
        };

        window.addCreditQty = (idx) => {
            const prod = inventory.find(p => p.id === creditCart[idx].id);
            if (creditCart[idx].quantity < prod.quantity) creditCart[idx].quantity++;
            updateCreditDisplay();
        };

        document.getElementById('save-credit')?.addEventListener('click', () => {
            const customer = document.getElementById('credit-customer').value.trim();
            const mobile = document.getElementById('credit-mobile').value.trim();
            if (!customer || creditCart.length === 0) { showAlert('Fill required fields', 'danger'); return; }

            credits.push({
                id: Date.now(),
                customerName: customer,
                mobile,
                items: [...creditCart],
                total: creditCart.reduce((sum, i) => sum + (i.sellingPrice * i.quantity), 0),
                totalProfit: creditCart.reduce((sum, i) => sum + ((i.sellingPrice - i.purchasePrice) * i.quantity), 0),
                date: new Date().toISOString(),
                paid: false
            });

            creditCart.forEach(item => {
                const prod = inventory.find(p => p.id === item.id);
                if (prod) prod.quantity -= item.quantity;
            });

            saveData();
            creditCart = [];
            updateCreditDisplay();
            document.getElementById('credit-customer').value = '';
            document.getElementById('credit-mobile').value = '';
            displayCredits();
            try { if (typeof populateCreditCustomerSelect === 'function') populateCreditCustomerSelect(); } catch(e){}
            showAlert('Credit saved');
        });

        function displayCredits() {
            const list = document.getElementById('credits-list');
            const search = document.getElementById('credit-search')?.value.toLowerCase() || '';
            const filtered = credits.filter(c => 
                c.customerName.toLowerCase().includes(search) || c.mobile.includes(search)
            );

            list.innerHTML = filtered.length ? filtered.map(c => `
                <div class="product-item">
                    <div style="flex: 1;">
                        <div class="product-name">${c.customerName}</div>
                        <div class="product-meta">Items: ${c.items.length} | ${c.mobile}</div>
                        <div style="margin-top: 6px;">
                            ${c.paid ? '<span class="badge" style="background: rgba(22,163,74,0.1); color: #16a34a;">‚úÖ PAID</span>' : '<span class="badge" style="background: rgba(220,38,38,0.1); color: #dc2626;">‚è≥ UNPAID</span>'}
                        </div>
                    </div>
                    <div class="product-price">${formatCurrency(c.total)}</div>
                </div>
            `).join('') : '<div class="empty-state">No credits</div>';
            // refresh credit-customer dropdown (if any)
            try { if (typeof populateCreditCustomerSelect === 'function') populateCreditCustomerSelect(); } catch(e){}
        }

        document.getElementById('credit-search')?.addEventListener('input', displayCredits);

        // Credit customers summary (for credit-customers page)
        function refreshCreditCustomersList(){
            const el = document.getElementById('credit-customers-list');
            if (!el) return;
            if (!credits || credits.length === 0) { el.innerHTML = '<div class="empty-state">No credit customers</div>'; return; }
            // aggregate unpaid balance by customer
            const map = {};
            credits.forEach(c => {
                const name = c.customerName || 'Unknown';
                const paidAmt = Number(c.paidAmount || 0);
                const totalAmt = Number(c.total || 0);
                const unpaid = Math.max(0, totalAmt - paidAmt);
                if (!map[name]) map[name] = { total:0, count:0, mobile: c.mobile || '' };
                // only sum unpaid amounts (so the customer summary reflects outstanding balance)
                map[name].total += unpaid;
                if (unpaid > 0) map[name].count++;
                if (!map[name].mobile && c.mobile) map[name].mobile = c.mobile;
            });
            el.innerHTML = Object.entries(map).map(([name, v]) => `
                <div class="product-item credit-customer-row" data-customer="${escapeHtml(name)}">
                    <div style="flex:1;">
                        <div class="product-name">${escapeHtml(name)}</div>
                        <div class="product-meta">${v.count} unpaid ‚Ä¢ ${escapeHtml(v.mobile)}</div>
                    </div>
                    <div class="product-price">${formatCurrency(v.total)}</div>
                </div>
            `).join('');

            // attach click handlers to open payment modal
            document.querySelectorAll('.credit-customer-row').forEach(r => {
                r.addEventListener('click', () => openCreditCustomerModal(r.getAttribute('data-customer')));
            });
        }

        // Populate a credit-customer <select> (if present) from known credits/customers
        function populateCreditCustomerSelect(){
            const dropdown = document.getElementById('credit-customer-select');
            if (!dropdown) return;
            // derive unique customers from credits records
            const map = {};
            credits.forEach(c => { if (c.customerName) map[c.customerName] = c; });
            const items = Object.values(map);
            dropdown.innerHTML = '<option value="">Select Customer</option>' + items.map(c => `<option value="${escapeHtml(String(c.id))}">${escapeHtml(c.customerName)}</option>`).join('');
        }

        // Open credit payment modal for a customer
        function openCreditCustomerModal(customerName){
            if (!customerName) return;
            const modal = document.getElementById('credit-pay-modal');
            const listEl = document.getElementById('credit-pay-list');
            const totEl = document.getElementById('credit-pay-total');
            const custEl = document.getElementById('credit-pay-customer');
            const customRow = document.getElementById('credit-pay-custom-row');
            const amountInp = document.getElementById('credit-pay-amount');
            custEl.textContent = customerName;
            // find unpaid credits for this customer
            const custCredits = credits.filter(c => (c.customerName||'') === customerName);
            // ensure paidAmount field
            custCredits.forEach(c=>{ if (c.paidAmount===undefined) c.paidAmount = 0; });
            const unpaid = custCredits.filter(c => !c.paid || (Number(c.paidAmount||0) < Number(c.total||0)));
            let totalUnpaid = unpaid.reduce((s,c)=> s + (Number(c.total||0) - Number(c.paidAmount||0)), 0);
            totEl.textContent = 'Total unpaid: ' + formatCurrency(totalUnpaid);
            if (!unpaid || unpaid.length === 0){ listEl.innerHTML = '<div class="empty-state">No unpaid credits</div>'; }
            else {
                listEl.innerHTML = unpaid.map(u => {
                    const rows = (u.items || []).map(item => `
                        <tr>
                            <td style="padding:8px 10px;border-bottom:1px dashed var(--border);">${escapeHtml(item.name || item.product || '')}</td>
                            <td style="padding:8px 10px;border-bottom:1px dashed var(--border);width:110px;text-align:right;">${formatCurrency(item.sellingPrice || item.price || 0)}</td>
                            <td style="padding:8px 10px;border-bottom:1px dashed var(--border);width:80px;text-align:center;">${escapeHtml(String(item.quantity || item.qty || 0))}</td>
                            <td style="padding:8px 10px;border-bottom:1px dashed var(--border);width:120px;text-align:right;">${formatCurrency((item.sellingPrice || item.price || 0) * Number(item.quantity || item.qty || 0))}</td>
                        </tr>
                    `).join('');

                    return `
                        <div style="padding:8px;border-bottom:1px solid var(--border);">
                            <div style="font-weight:700;">${escapeHtml(u.customerName || '')}</div>
                            <div style="font-size:13px;color:var(--text-color);opacity:0.8;">${new Date(u.date).toLocaleString()}</div>
                            <div class="table-container responsive-scroll" style="margin-top:8px;border-radius:8px;border:1px solid var(--border-color);">
                                <table style="width:100%;border-collapse:collapse;font-size:13px;min-width:520px;">
                                    <thead>
                                        <tr>
                                            <th style="padding:8px;background:var(--card-bg);color:var(--text-color);text-align:left;">PRODUCT</th>
                                            <th style="padding:8px;background:var(--card-bg);color:var(--text-color);text-align:right;">PRICE</th>
                                            <th style="padding:8px;background:var(--card-bg);color:var(--text-color);text-align:center;">QTY</th>
                                            <th style="padding:8px;background:var(--card-bg);color:var(--text-color);text-align:right;">TOTAL</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${rows}
                                    </tbody>
                                </table>
                            </div>
                            <div style="margin-top:6px;">Amount: ${formatCurrency(u.total)} ‚Äî Paid: ${formatCurrency(u.paidAmount || 0)} ‚Äî Balance: ${formatCurrency((Number(u.total || 0) - Number(u.paidAmount || 0)))}</div>
                        </div>
                    `;
                }).join('');
            }
            // reset custom
            customRow.style.display = 'none'; if (amountInp) amountInp.value = '';
            modal.dataset.customer = customerName;
            modal.dataset.total = String(totalUnpaid);
            modal.classList.add('active');
        }

        document.getElementById('close-credit-pay')?.addEventListener('click', ()=>{ document.getElementById('credit-pay-modal').classList.remove('active'); });
        document.getElementById('credit-pay-custom')?.addEventListener('click', ()=>{ document.getElementById('credit-pay-custom-row').style.display = 'block'; });
        document.getElementById('credit-pay-full')?.addEventListener('click', ()=>{
            const modal = document.getElementById('credit-pay-modal'); if (!modal) return;
            const customer = modal.dataset.customer; const total = Number(modal.dataset.total||0);
            if (!customer || total <= 0) return showAlert('Nothing to pay','danger');
            processCreditPayment(customer, total);
        });
        document.getElementById('credit-pay-custom-confirm')?.addEventListener('click', ()=>{
            const modal = document.getElementById('credit-pay-modal'); if (!modal) return;
            const customer = modal.dataset.customer; const raw = document.getElementById('credit-pay-amount').value;
            const amount = parseFloat(raw) || 0; if (amount <= 0) return showAlert('Enter an amount','danger');
            processCreditPayment(customer, amount);
        });

        function processCreditPayment(customerName, amountPaid){
            if (!customerName) return;
            let remaining = Number(amountPaid || 0);
            const custCredits = credits.filter(c => (c.customerName||'') === customerName).sort((a,b)=> new Date(a.date) - new Date(b.date));
            // ensure paidAmount
            custCredits.forEach(c=>{ if (c.paidAmount===undefined) c.paidAmount = 0; });

            const paymentsMade = []; // { creditId, amount, creditRef }
            const fullyPaidIds = [];

            for (const c of custCredits){
                const bal = Number(c.total||0) - Number(c.paidAmount||0);
                if (bal <= 0) continue;
                if (remaining <= 0) break;
                const prevPaid = Number(c.paidAmount||0);
                const give = Math.min(remaining, bal);
                c.paidAmount = prevPaid + give;
                remaining -= give;
                paymentsMade.push({ creditId: c.id, amount: give, creditRef: c });
                if (Number(c.paidAmount) >= Number(c.total || 0)){
                    c.paid = true;
                    fullyPaidIds.push(c.id);
                }
            }

            // record paymentHistory entries for individual payments
            paymentsMade.forEach(pm => {
                const cref = pm.creditRef;
                paymentHistory.push({ id: Date.now()+Math.floor(Math.random()*999), date: (new Date()).toISOString(), amount: pm.amount, customerName: cref.customerName || customerName, items: JSON.parse(JSON.stringify(cref.items || [])) });
            });

            // For any fully paid credits, convert to sales so profit is counted
            const createdSales = [];
            if (fullyPaidIds.length > 0){
                // process each fully-paid credit (create sale, remove credit)
                fullyPaidIds.forEach(id => {
                    const idx = credits.findIndex(x => String(x.id) === String(id));
                    if (idx === -1) return;
                    const creditRec = credits[idx];
                    const sale = { id: Date.now()+Math.floor(Math.random()*999), date: (new Date()).toISOString(), dateString: (new Date()).toLocaleDateString(), items: JSON.parse(JSON.stringify(creditRec.items || [])), total: Number(creditRec.total || 0), totalProfit: Number(creditRec.totalProfit || 0), isFromCredit: true };
                    sales.push(sale);
                    createdSales.push(sale);
                    credits.splice(idx, 1);
                });
            }

            // persist changes
            saveData();
            // update UI
            displayCredits();
            refreshCreditCustomersList();
            displayInventory();
            // If no individual payment entries were recorded, add a summary entry
            const paid = Number(amountPaid) - Number(remaining || 0);
            if (paid > 0 && paymentsMade.length === 0) paymentHistory.push({ id: Date.now(), date: (new Date()).toISOString(), customerName, amount: paid });
            saveData();
            // refresh dashboard as payments affect today's revenue and realized profit
            try{ updateDashboard(); }catch(e){}
            document.getElementById('credit-pay-modal').classList.remove('active');
            let msg = 'Payment recorded';
            if (createdSales.length > 0) msg = `${createdSales.length} credit(s) settled ‚Äî profit realized.`;
            showAlert(msg);
        }

        // Sales
        function displaySales() {
            const list = document.getElementById('sales-list');
            const sorted = sales.slice().reverse();
            list.innerHTML = sorted.length ? sorted.map(s => {
                const rows = (s.items || []).map(item => `
                    <tr>
                        <td style="padding:12px 10px;border-bottom:1px dashed var(--border-color);">${escapeHtml(item.name || item.product || '')}</td>
                        <td style="padding:12px 10px;border-bottom:1px dashed var(--border-color);width:110px;text-align:right;">${formatCurrency(item.sellingPrice || item.price || 0)}</td>
                        <td style="padding:12px 10px;border-bottom:1px dashed var(--border-color);width:80px;text-align:center;">${escapeHtml(String(item.quantity || item.qty || 0))}</td>
                        <td style="padding:12px 10px;border-bottom:1px dashed var(--border-color);width:120px;text-align:right;">${formatCurrency((item.sellingPrice || item.price || 0) * Number(item.quantity || item.qty || 0))}</td>
                    </tr>
                `).join('');

                return `
                    <div class="card">
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
                            <div>
                                <div style="font-weight:800;color:var(--primary);">Sale #${escapeHtml(String(s.id))}</div>
                                <div style="font-size:13px;color:var(--text-color);opacity:0.8;">${new Date(s.date).toLocaleString()}</div>
                            </div>
                            <div style="font-size:20px;font-weight:800;color:var(--primary);">${formatCurrency(s.total)}</div>
                        </div>

                        <div class="table-container responsive-scroll" style="margin-top:12px;border-radius:8px;border:1px solid var(--border-color);">
                            <table style="width:100%;border-collapse:collapse;font-size:13px;min-width:520px;">
                                <thead>
                                    <tr>
                                        <th style="padding:10px;background:#f8fafc;color:#0f172a;text-align:left;">PRODUCT</th>
                                        <th style="padding:10px;background:#f8fafc;color:#0f172a;text-align:right;">PRICE</th>
                                        <th style="padding:10px;background:#f8fafc;color:#0f172a;text-align:center;">QTY</th>
                                        <th style="padding:10px;background:#f8fafc;color:#0f172a;text-align:right;">TOTAL</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rows}
                                </tbody>
                            </table>
                        </div>

                    </div>
                `;
            }).join('') : '<div class="empty-state">No sales</div>';
        }

        function displayPaymentHistory(){
            const container = document.getElementById('payment-history-list');
            if (!container) return;
            if (!paymentHistory || paymentHistory.length === 0) { container.innerHTML = '<div class="empty-state">No payment history</div>'; return; }
            const html = paymentHistory.slice().reverse().map(p => `
                <div class="card">
                    <div style="font-weight:700;">${escapeHtml(p.customerName || p.customer || 'Unknown')}</div>
                    <div style="font-size:13px;color:var(--text-color);opacity:0.8;">${new Date(p.date || p.timestamp || Date.now()).toLocaleString()}</div>
                    <div style="margin-top:6px;font-weight:700;color:var(--primary);">${formatCurrency(p.amount || 0)}</div>
                    <div style="margin-top:6px;font-size:13px;">${(p.items && p.items.length>0)? (p.items.length + ' item(s)') : ''}</div>
                </div>
            `).join('');
            container.innerHTML = html;
        }

        function openPaymentHistoryModal(){
            displayPaymentHistory();
            document.getElementById('payment-history-modal')?.classList.add('active');
        }

        document.getElementById('open-payment-history')?.addEventListener('click', openPaymentHistoryModal);
        document.getElementById('close-payment-history')?.addEventListener('click', ()=>{ document.getElementById('payment-history-modal')?.classList.remove('active'); });

        // Optional small sale detail viewer (shows items) used by View Details on each sale
        window.openSaleHistory = function(saleId){
            const s = sales.find(x => String(x.id) === String(saleId));
            if (!s) return showAlert('Sale not found','danger');
            const content = s.items.map(i => `<div style="display:flex;justify-content:space-between;"><div>${escapeHtml(i.name||i.product||'')}</div><div>${i.quantity} x ${formatCurrency(i.sellingPrice||i.price||0)}</div></div>`).join('');
            const modal = document.getElementById('payment-history-modal');
            const container = document.getElementById('payment-history-list');
            if (!modal || !container) return;
            container.innerHTML = `<div class="card"><div style="font-weight:700;">Sale #${s.id} ‚Äî ${new Date(s.date).toLocaleString()}</div><div style="margin-top:8px;">${content}</div><div style="margin-top:8px;font-weight:700;color:var(--primary);">Total: ${formatCurrency(s.total)}</div></div>`;
            modal.classList.add('active');
        };

        // Purchases
        function displayPurchases() {
            const tableBody = document.getElementById('purchases-table-body');
            const container = document.getElementById('purchases-list');
            const totalEl = document.getElementById('purchases-total');

            const calcTotal = (purchases || []).reduce((s, p) => {
                const qty = Number(p.quantity || p.qty || 0);
                const unit = Number(p.purchasePrice || p.unitCost || p.purchase_cost || 0);
                const t = Number(p.totalCost || (unit * qty) || 0);
                return s + (isNaN(t) ? 0 : t);
            }, 0);
            if (totalEl) totalEl.textContent = formatCurrency(calcTotal);

            if (!purchases || purchases.length === 0) {
                if (tableBody) {
                    tableBody.innerHTML = `<tr class="empty-purchases-row"><td colspan="10">No purchase records</td></tr>`;
                    return;
                }
                if (container) {
                    container.innerHTML = '<div class="empty-state">No purchases</div>';
                    return;
                }
            }

            if (tableBody) {
                const rows = purchases.slice().reverse().map(p => {
                    const date = escapeHtml(new Date(p.date || p.createdAt || Date.now()).toLocaleString());
                    const company = escapeHtml(p.company || p.supplier || '');
                    const sr = escapeHtml(p.sr || p.srNo || '');
                    const prod = escapeHtml(p.productName || p.product || '');
                    const barcode = escapeHtml(p.barcode || '');
                    const qty = escapeHtml(String(p.quantity || p.qty || ''));
                    const unit = formatCurrency(p.purchasePrice || p.unitCost || 0);
                    const total = formatCurrency(p.totalCost || ((Number(p.purchasePrice || p.unitCost || 0) * Number(p.quantity || p.qty || 0)) || 0));
                    const invoice = escapeHtml(p.invoice || p.inv || '');
                    const payment = escapeHtml(p.payment || p.paymentMethod || '');
                    return `
                        <tr>
                            <td>${date}</td>
                            <td>${company}</td>
                            <td>${sr}</td>
                            <td>${prod}</td>
                            <td><code>${barcode}</code></td>
                            <td>${qty}</td>
                            <td>${unit}</td>
                            <td>${total}</td>
                            <td>${invoice}</td>
                            <td>${payment}</td>
                        </tr>
                    `;
                }).join('');
                tableBody.innerHTML = rows;
                return;
            }

            // Fallback legacy card view
            if (container) {
                const html = purchases.slice().reverse().map(p => `
                    <div class="card">
                        <div class="card-title">${new Date(p.date).toLocaleString()}</div>
                        <div style="font-size:13px;">Product: ${p.productName || ''} (${p.barcode || ''})</div>
                        <div style="font-size:14px;font-weight:700;color:var(--primary);margin-top:6px;">${formatCurrency(p.totalCost || 0)}</div>
                    </div>
                `).join('');
                container.innerHTML = html;
            }
        }

        // Owner Draw helpers
        function renderOwnerDrawsArchive(){
            const list = JSON.parse(localStorage.getItem('ownerDrawsArchive') || '[]');
            const container = document.getElementById('owner-draw-archive-list');
            if (!container) return;
            container.innerHTML = list.length ? list.slice().reverse().map(s=>`
                <div class="card" style="padding:10px;margin-bottom:8px;cursor:pointer;" onclick="showOwnerDrawArchiveSnapshot('${s.id}')">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                        <div style="font-weight:700;">${new Date(s.archivedAt).toLocaleString()}</div>
                        <div style="color:var(--text-color);opacity:0.8;">${s.count} draws ‚Äî ${formatCurrency(s.total||0)}</div>
                    </div>
                </div>
            `).join('') : '<div class="empty-state">No archived snapshots</div>';
        }

        // Show detailed snapshot view inside archive modal
        function showOwnerDrawArchiveSnapshot(id){
            const archive = JSON.parse(localStorage.getItem('ownerDrawsArchive') || '[]');
            const snap = archive.find(s => String(s.id) === String(id));
            const container = document.getElementById('owner-draw-archive-list');
            if (!snap || !container) return showAlert('Snapshot not found','danger');

            // build header and table
            const headerHtml = `
                <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;">
                    <div style="flex:1;">
                        <div style="font-weight:800;font-size:18px;">Snapshot: ${new Date(snap.archivedAt).toLocaleString()}</div>
                        <div style="margin-top:8px;color:var(--text-color);opacity:0.8;">Preview:</div>
                    </div>
                    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;">
                        <div style="color:var(--text-color);opacity:0.8;">${snap.count} draws ‚Äî ${formatCurrency(snap.total||0)}</div>
                        <div style="display:flex;gap:8px;">
                            <button class="btn small" onclick="renderOwnerDrawsArchive();">Back</button>
                            <button class="btn small" onclick="(function(){ const a = document.createElement('a'); a.href = 'data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(snap, null, 2)); a.download = 'owner-draw-archive-${snap.id}.json'; document.body.appendChild(a); a.click(); a.remove(); })()">Export</button>
                        </div>
                    </div>
                </div>
                <div style="margin-top:12px;"/>
            `;

            const rows = (snap.draws || []).map(d => `
                <tr>
                    <td>${escapeHtml(new Date(d.date).toLocaleString())}</td>
                    <td>${escapeHtml(d.type || '')}</td>
                    <td>${escapeHtml(d.productName || d.note || '')}</td>
                    <td style="text-align:center;">${escapeHtml(String(d.quantity || d.amount || ''))}</td>
                    <td style="text-align:right;">${formatCurrency(d.total || d.amount || 0)}</td>
                </tr>
            `).join('');

            const tableHtml = `
                <div class="table-container responsive-scroll" style="margin-top:12px;border-radius:8px;border:1px solid var(--border-color);">
                    <table style="width:100%;border-collapse:collapse;font-size:13px;min-width:520px;">
                        <thead>
                            <tr>
                                <th style="padding:10px;background:#f8fafc;color:#0f172a;text-align:left;">DATE</th>
                                <th style="padding:10px;background:#f8fafc;color:#0f172a;text-align:left;">TYPE</th>
                                <th style="padding:10px;background:#f8fafc;color:#0f172a;text-align:left;">PRODUCT/NOTE</th>
                                <th style="padding:10px;background:#f8fafc;color:#0f172a;text-align:center;">QTY/AMOUNT</th>
                                <th style="padding:10px;background:#f8fafc;color:#0f172a;text-align:right;">TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = headerHtml + tableHtml;
        }

        function downloadOwnerDrawSnapshot(id){
            const archive = JSON.parse(localStorage.getItem('ownerDrawsArchive') || '[]');
            const snap = archive.find(s => String(s.id) === String(id));
            if (!snap) return showAlert('Snapshot not found','danger','owner-draw-alert');
            const a = document.createElement('a');
            const data = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(snap, null, 2));
            a.href = data; a.download = `owner-draw-archive-${snap.id}.json`; document.body.appendChild(a); a.click(); a.remove();
        }

        async function archiveAndClearOwnerDraws(){
            if (!ownerDraws || ownerDraws.length === 0) return showAlert('No owner draws to archive','danger','owner-draw-alert');
            const ok = await appConfirm('Archive current owner draws and clear?');
            if (!ok) return;
            const archive = JSON.parse(localStorage.getItem('ownerDrawsArchive') || '[]');
            const snapshot = { id: Date.now(), archivedAt: (new Date()).toISOString(), count: ownerDraws.length, total: ownerDraws.reduce((s,d)=>s+Number(d.total||0),0), draws: ownerDraws };
            archive.push(snapshot);
            localStorage.setItem('ownerDrawsArchive', JSON.stringify(archive));
            ownerDraws = [];
            saveData();
            displayInventory();
            displayPurchases();
            displayCredits();
            showAlert('Owner draws archived','success','owner-draw-alert');
            renderOwnerDrawsArchive();
        }

        function displayOwnerDraws(){
            const tbody = document.getElementById('owner-draw-table-body');
            const totalEl = document.getElementById('owner-draw-total');
            if (!tbody || !totalEl) return;
            if (!ownerDraws || ownerDraws.length === 0){
                tbody.innerHTML = '<tr class="empty-od-row"><td colspan="7">No owner draws recorded</td></tr>';
                totalEl.textContent = formatCurrency(0);
                return;
            }

            const rows = ownerDraws.slice().reverse().map(d => {
                const date = escapeHtml(new Date(d.date).toLocaleString());
                const prod = escapeHtml(d.type === 'cash' ? 'Cash' : (d.productName || d.product || ''));
                const qty = escapeHtml(String(d.quantity || ''));
                const unit = formatCurrency(d.unit || d.purchasePrice || 0);
                const total = formatCurrency(Number(d.total || d.amount || 0));
                const loss = formatCurrency(Number(d.loss || 0));
                const note = escapeHtml(d.note || '');
                return `
                    <tr>
                        <td>${date}</td>
                        <td>${prod}</td>
                        <td>${qty}</td>
                        <td>${unit}</td>
                        <td>${total}</td>
                        <td>${loss}</td>
                        <td>${note}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;
            const total = ownerDraws.reduce((s,d)=>s + Number(d.total||d.amount||0), 0);
            totalEl.textContent = formatCurrency(total);
        }

        // owner-draw form binding
        document.getElementById('owner-draw-form')?.addEventListener('submit', function(e){
            e.preventDefault();
            const type = document.getElementById('owner-draw-type').value;
            const qty = parseFloat(document.getElementById('owner-draw-quantity').value) || 0;
            const note = document.getElementById('owner-draw-note').value || '';
            let productId = null, productName = '';
            if (type === 'product'){
                productId = document.getElementById('owner-draw-product').value;
                const prod = inventory.find(p => String(p.id) === String(productId));
                if (!prod) return showAlert('Please select a product','danger','owner-draw-alert');
                productName = prod.name;
                prod.quantity = Math.max(0, Number(prod.quantity||0) - qty);
            }
            const unitCost = inventory.find(p=>String(p.id)===String(productId))?.purchasePrice || 0;
            const entry = { id: Date.now(), date: (new Date()).toISOString(), type, productId, productName, quantity: qty, amount: (type==='cash'?qty:0), total: (type==='cash'?qty: (qty * unitCost)), unit: unitCost, loss: 0, note };
            ownerDraws.push(entry);
            saveData(); displayInventory(); displayOwnerDraws(); updateOwnerDrawSummary(); showAlert('Owner draw recorded','success','owner-draw-alert');
            this.reset();
        });

        document.getElementById('owner-draw-clear-btn')?.addEventListener('click', ()=>{ archiveAndClearOwnerDraws(); });

        document.getElementById('owner-draw-archive-btn')?.addEventListener('click', ()=>{
            renderOwnerDrawsArchive();
            document.getElementById('owner-draw-archive-modal')?.classList.add('active');
        });
        document.getElementById('close-owner-draw-archive')?.addEventListener('click', ()=>{ document.getElementById('owner-draw-archive-modal')?.classList.remove('active'); });

        // Edit/Delete product handlers
        function openEditProductModal(id){
            const modal = document.getElementById('edit-product-modal');
            const prod = inventory.find(p => String(p.id) === String(id));
            if (!prod) return showAlert('Product not found','danger');
            document.getElementById('edit-prod-name').value = prod.name || '';
            document.getElementById('edit-prod-barcode').value = prod.barcode || '';
            document.getElementById('edit-prod-purchase').value = prod.purchasePrice || 0;
            document.getElementById('edit-prod-selling').value = prod.sellingPrice || 0;
            // show current stock and default add stock to 0
            document.getElementById('edit-prod-current').value = prod.quantity || 0;
            document.getElementById('edit-prod-add').value = 0;
            modal.dataset.editId = String(id);
            modal.classList.add('active');
        }

        document.getElementById('close-edit-product')?.addEventListener('click', ()=>{ document.getElementById('edit-product-modal').classList.remove('active'); });

        document.getElementById('edit-product-form')?.addEventListener('submit', function(e){
            e.preventDefault();
            const id = document.getElementById('edit-product-modal').dataset.editId;
            const idx = inventory.findIndex(p => String(p.id) === String(id));
            if (idx === -1) return showAlert('Product not found','danger');
            const prod = inventory[idx];
            prod.name = document.getElementById('edit-prod-name').value.trim();
            prod.barcode = document.getElementById('edit-prod-barcode').value.trim();
            prod.purchasePrice = parseFloat(document.getElementById('edit-prod-purchase').value) || 0;
            prod.sellingPrice = parseFloat(document.getElementById('edit-prod-selling').value) || 0;
            // apply added stock (if any)
            const add = parseInt(document.getElementById('edit-prod-add').value) || 0;
            prod.quantity = (Number(prod.quantity || 0) + add);
            // Always record added stock as a purchase entry when quantity is increased
            if (add > 0) {
                purchases.push({ id: Date.now()+Math.floor(Math.random()*999), date: (new Date()).toISOString(), productId: prod.id, productName: prod.name, barcode: prod.barcode, quantity: add, purchasePrice: prod.purchasePrice, totalCost: Number(prod.purchasePrice) * add });
            }
            // clear any forwarded flag
            delete document.getElementById('edit-product-modal').dataset.recordPurchase;
            saveData(); displayInventory(); document.getElementById('edit-product-modal').classList.remove('active'); showAlert('Product updated');
        });
        
        // Delete (confirm) button in edit modal: remove product or all duplicates
        document.getElementById('delete-product-confirm')?.addEventListener('click', async function(){
            const id = document.getElementById('edit-product-modal')?.dataset.editId;
            if (!id) return showAlert('No product selected','danger');
            // Offer to remove duplicates: ask user
            const removeAll = await appConfirm('Also remove duplicate products with same barcode?');
            if (removeAll) await deleteProduct(id, true);
            else await deleteProduct(id, false);
        });
        async function deleteProduct(idOrBarcode, removeDuplicates = false){
            // locate product by id first, fallback to barcode
            let idx = inventory.findIndex(p => String(p.id) === String(idOrBarcode));
            if (idx === -1) idx = inventory.findIndex(p => String(p.barcode) === String(idOrBarcode));
            if (idx === -1) return showAlert('Product not found','danger');
            const prod = inventory[idx];
            const barcode = prod.barcode;

            if (removeDuplicates) {
                const ok = await appConfirm('Delete ALL products with this barcode?');
                if (!ok) return;
                inventory = inventory.filter(p => String(p.barcode) !== String(barcode));
                saveData(); displayInventory(); showAlert('All duplicate products removed');
                // close edit modal if open
                document.getElementById('edit-product-modal')?.classList.remove('active');
                return;
            }

            const ok = await appConfirm('Delete this product?');
            if (!ok) return;
            const removeIdx = inventory.findIndex(p => String(p.id) === String(prod.id));
            if (removeIdx === -1) return showAlert('Product not found','danger');
            inventory.splice(removeIdx,1);
            saveData(); displayInventory(); showAlert('Product deleted');
            document.getElementById('edit-product-modal')?.classList.remove('active');
        }

        // Reports
        document.getElementById('generate-report')?.addEventListener('click', () => {
            const dateStr = document.getElementById('report-date').value;
            const range = document.getElementById('report-range').value;
            if (!dateStr) { showAlert('Select a date', 'danger'); return; }

            const base = new Date(dateStr);
            let start = new Date(base);
            let end = new Date(base);
            start.setHours(0, 0, 0, 0);
            end.setHours(23, 59, 59, 999);

            if (range === 'weekly') {
                const day = base.getDay();
                start.setDate(base.getDate() - day);
                end.setDate(start.getDate() + 6);
                end.setHours(23, 59, 59, 999);
            } else if (range === 'monthly') {
                start = new Date(base.getFullYear(), base.getMonth(), 1);
                end = new Date(base.getFullYear(), base.getMonth() + 1, 0);
                end.setHours(23, 59, 59, 999);
            }

            // Filter relevant records
            const relevantSales = (sales || []).filter(s => { const d = new Date(s.date); return d >= start && d <= end; });
            const relevantPurchases = (purchases || []).filter(p => { const d = new Date(p.date); return d >= start && d <= end; });
            const relevantDraws = (ownerDraws || []).filter(d => { const dt = new Date(d.date || d.timestamp || Date.now()); return dt >= start && dt <= end; });

            const salesTotal = relevantSales.reduce((sum, s) => sum + (Number(s.total || 0)), 0);
            const purchasesTotal = relevantPurchases.reduce((sum, p) => sum + (Number(p.totalCost || (Number(p.purchasePrice || 0) * Number(p.quantity || 0))) || 0), 0);
            const profitBeforeDraws = relevantSales.reduce((sum, s) => sum + (Number(s.totalProfit || 0)), 0);
            const drawsTotal = relevantDraws.reduce((sum, d) => sum + (Number(d.amount || 0)), 0);
            const netProfit = profitBeforeDraws - drawsTotal;

            // Build Sales Transactions table
            let salesSectionHtml = '';
                if (!relevantSales.length) {
                salesSectionHtml = '<div class="empty-state">No sales</div>';
            } else {
                const rows = relevantSales.map(s => {
                    const date = new Date(s.date).toLocaleString();
                    const itemsCount = (s.items || []).reduce((n,i)=> n + (Number(i.quantity||i.qty||0)), 0);
                    const productNames = (s.items || []).map(i => (i.name || i.product || '')).filter(Boolean).join(', ');
                    return `
                        <tr>
                            <td style="padding:10px;border-bottom:1px dashed var(--border-color);">${escapeHtml(date)}</td>
                            <td style="padding:10px;border-bottom:1px dashed var(--border-color);">${escapeHtml(productNames || String(s.id||''))}</td>
                            <td style="padding:10px;border-bottom:1px dashed var(--border-color);text-align:center;">${itemsCount}</td>
                            <td style="padding:10px;border-bottom:1px dashed var(--border-color);text-align:right;">${formatCurrency(Number(s.total||0))}</td>
                        </tr>
                    `;
                }).join('');

                salesSectionHtml = `
                    <div class="table-container responsive-scroll" style="border-radius:8px;border:1px solid var(--border-color);">
                        <table style="width:100%;border-collapse:collapse;font-size:13px;min-width:520px;">
                            <thead>
                                <tr>
                                    <th style="padding:10px;text-align:left;">DATE</th>
                                    <th style="padding:10px;text-align:left;">PRODUCT</th>
                                    <th style="padding:10px;text-align:center;width:80px;">ITEMS</th>
                                    <th style="padding:10px;text-align:right;width:140px;">TOTAL</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Build Purchases table (show Product, Qty and Amount)
            let purchasesSectionHtml = '';
            if (!relevantPurchases.length) {
                purchasesSectionHtml = '<div class="empty-state">No purchases</div>';
            } else {
                const prow = relevantPurchases.map(p => {
                    // resolve product name: prefer stored productName, else lookup by id in inventory
                    let prodLabel = p.productName || p.name || '';
                    try {
                        if ((!prodLabel || prodLabel.trim() === '') && p.productId) {
                            const prod = inventory.find(x => String(x.id) === String(p.productId));
                            if (prod) prodLabel = prod.name || prod.product || prodLabel;
                        }
                    } catch (e) { /* ignore */ }

                    const qty = escapeHtml(String(p.quantity || p.qty || 0));
                    const amount = formatCurrency(Number(p.totalCost || (Number(p.purchasePrice||0) * Number(p.quantity||0)) || 0));
                    return `
                    <tr>
                        <td style="padding:10px;border-bottom:1px dashed var(--border-color);">${escapeHtml(prodLabel)}</td>
                        <td style="padding:10px;border-bottom:1px dashed var(--border-color);text-align:center;">${qty}</td>
                        <td style="padding:10px;border-bottom:1px dashed var(--border-color);text-align:right;">${amount}</td>
                    </tr>
                `}).join('');

                purchasesSectionHtml = `
                    <div class="table-container responsive-scroll" style="border-radius:8px;border:1px solid var(--border-color);">
                        <table style="width:100%;border-collapse:collapse;font-size:13px;min-width:520px;">
                            <thead>
                                <tr>
                                    <th style="padding:10px;text-align:left;">PRODUCT</th>
                                    <th style="padding:10px;text-align:center;width:80px;">QTY</th>
                                    <th style="padding:10px;text-align:right;width:140px;">AMOUNT</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${prow}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Render metrics and sections (keeps existing layout elsewhere unchanged)
            document.getElementById('report-output').innerHTML = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Sales</div>
                        <div class="metric-value">${formatCurrency(salesTotal)}</div>
                        <div class="metric-subtitle">${relevantSales.length} transactions</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Purchases</div>
                        <div class="metric-value">${formatCurrency(purchasesTotal)}</div>
                        <div class="metric-subtitle">${relevantPurchases.length} records</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Profit</div>
                        <div class="metric-value">${formatCurrency(profitBeforeDraws)}</div>
                        <div class="metric-subtitle">Before draws</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Owner Draws</div>
                        <div class="metric-value">${formatCurrency(drawsTotal)}</div>
                        <div class="metric-subtitle">Loss: ${formatCurrency(drawsTotal)}</div>
                    </div>
                </div>

                <div class="net-profit-card">
                    <div class="metric-label">Net Profit</div>
                    <div class="metric-value">${formatCurrency(netProfit)}</div>
                    <div class="metric-subtitle">After draws</div>
                </div>

                <div class="transactions-grid">
                    <div class="transactions-section">
                        <div class="section-title">Sales Transactions</div>
                        ${salesSectionHtml}

                        <div style="height:12px;"></div>
                        <div class="section-title">Purchases</div>
                        ${purchasesSectionHtml}
                    </div>

                   
                </div>
            `;
        });

        // Download PDF of report-output
        document.getElementById('download-pdf')?.addEventListener('click', () => {
            const out = document.getElementById('report-output');
            if (!out || !out.innerHTML.trim()) { showAlert('Generate report first', 'danger'); return; }
            const dateVal = document.getElementById('report-date')?.value || new Date().toISOString().slice(0,10);
            const filename = `report-${dateVal}.pdf`;
            const opt = {
                margin: 0.5,
                filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };
            try {
                html2pdf().set(opt).from(out).save();
            } catch (e) {
                console.error(e);
                showAlert('Failed to generate PDF', 'danger');
            }
        });

        // Backup
        document.getElementById('export-btn')?.addEventListener('click', () => {
            const backup = { inventory, sales, credits, purchases, paymentHistory, ownerDraws };
            const json = JSON.stringify(backup, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showAlert('Backup exported');
        });

        document.getElementById('import-btn')?.addEventListener('click', () => {
            document.getElementById('import-file').click();
        });

        document.getElementById('import-file')?.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const obj = JSON.parse(ev.target.result);
                    inventory = obj.inventory || [];
                    sales = obj.sales || [];
                    credits = obj.credits || [];
                    purchases = obj.purchases || [];
                    paymentHistory = obj.paymentHistory || [];
                    ownerDraws = obj.ownerDraws || [];
                    saveData();
                    updateDashboard();
                    displayInventory();
                    displaySales();
                    displayCredits();
                    try { if (typeof populateCreditCustomerSelect === 'function') populateCreditCustomerSelect(); } catch(e){}
                    showAlert('Backup imported');
                } catch (err) {
                    showAlert('Invalid backup file', 'danger');
                }
            };
            reader.readAsText(file);
        });

        // Quick POS FAB
        document.getElementById('quick-pos')?.addEventListener('click', () => {
            // Navigate to POS page via menu (tab-bar removed)
            document.querySelectorAll('.tab-item, .menu-item').forEach(b => b.classList.remove('active'));
            document.querySelector(`.menu-item[data-page="pos"]`)?.classList.add('active');
            document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
            const posPage = document.getElementById('page-pos');
            if (posPage) { posPage.classList.add('active'); updatePage('pos'); }
            document.getElementById('menu-modal')?.classList.remove('active');
        });

        // Automatic sync: save periodically (removed manual sync button)
        setInterval(() => {
            try { saveData(); } catch (e) { /* ignore */ }
        }, 5000);

        // Deduplicate inventory on load to remove accidental duplicate entries
        try { dedupeInventory(); } catch (e) {}

        // Setup table-detail modal: clone any table into a full-detail modal on click
        (function setupTableDetailModal(){
            const modal = document.getElementById('table-detail-modal');
            const content = document.getElementById('table-detail-content');
            const titleEl = document.getElementById('table-detail-title');
            const closeBtn = document.getElementById('close-table-detail');

            if (!modal || !content) return;

            function openTableModal(origTable, title){
                // clear
                content.innerHTML = '';
                titleEl && (titleEl.textContent = title || 'Table Details');

                // clone table to preserve original behavior
                const clone = origTable.cloneNode(true);
                // ensure cloned table doesn't keep interactive handlers
                clone.querySelectorAll('button, input, a').forEach(n => n.removeAttribute('onclick'));
                // Make sure table can expand horizontally inside modal
                clone.style.width = 'auto';
                clone.style.minWidth = 'max-content';
                clone.style.tableLayout = 'auto';

                // ensure cells don't wrap so columns stay visible
                clone.querySelectorAll('th, td').forEach(c => c.style.whiteSpace = 'nowrap');

                const wrapper = document.createElement('div');
                wrapper.style.overflow = 'auto';
                wrapper.style.maxHeight = '70vh';
                wrapper.appendChild(clone);
                content.appendChild(wrapper);

                modal.classList.add('active');
            }

            function closeModal(){
                modal.classList.remove('active');
                content.innerHTML = '';
            }

            // close handlers
            closeBtn?.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

            // attach click listeners to every table in .table-container
            document.querySelectorAll('.table-container table').forEach(tbl => {
                // give a hint
                tbl.style.cursor = 'zoom-in';
                tbl.addEventListener('click', (e) => {
                    // ignore clicks on interactive elements inside table
                    if (e.target.closest('button') || e.target.closest('a') || e.target.closest('input')) return;
                    // derive a friendly title
                    const cardTitle = tbl.closest('.card')?.querySelector('.card-title')?.textContent?.trim();
                    const derived = tbl.getAttribute('data-title') || cardTitle || (tbl.id || 'Table Details');
                    openTableModal(tbl, derived);
                });
            });
        })();

        // Initialize
        updateDashboard();
    </script>
</body>
</html>
